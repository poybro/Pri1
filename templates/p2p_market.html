<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ª£ Giao D·ªãch SOK - P2P</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 960px; }
        .card-title { color: #0d6efd; }
        .table-hover tbody tr:hover {
            background-color: #e9ecef;
            cursor: pointer;
        }
        .text-monospace { font-family: monospace; }
        .status-open { color: #198754; font-weight: bold; }
        .status-pending { color: #ffc107; font-weight: bold; }
        .status-completed { color: #6c757d; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="text-center mb-4">
            <h1 class="display-5">üõí Ch·ª£ Giao D·ªãch P2P SOK</h1>
            <p class="lead">N∆°i mua b√°n SOK an to√†n v√† minh b·∫°ch gi·ªØa c√°c th√†nh vi√™n.</p>
        </div>

        <!-- Khu v·ª±c qu·∫£n l√Ω v√≠ (gi·∫£ l·∫≠p) -->
        <div class="card mb-4">
             <div class="card-body">
                <h5 class="card-title">V√≠ C·ªßa B·∫°n</h5>
                <div class="mb-3">
                    <label for="privateKeyInput" class="form-label">Private Key PEM:</label>
                    <textarea class="form-control" id="privateKeyInput" rows="3" placeholder="D√°n Private Key c·ªßa b·∫°n v√†o ƒë√¢y ƒë·ªÉ th·ª±c hi·ªán giao d·ªãch"></textarea>
                </div>
                 <button class="btn btn-primary" onclick="loadMyWallet()">N·∫°p V√≠</button>
                 <div id="walletInfo" class="mt-3" style="display:none;">
                     <strong>ƒê·ªãa ch·ªâ v√≠:</strong> <span id="walletAddress" class="text-monospace"></span><br>
                     <strong>S·ªë d∆∞:</strong> <span id="walletBalance"></span> SOK
                 </div>
            </div>
        </div>

        <!-- Khu v·ª±c t·∫°o l·ªánh -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">T·∫°o L·ªánh B√°n M·ªõi</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="sokAmount" class="form-label">S·ªë l∆∞·ª£ng SOK mu·ªën b√°n</label>
                        <input type="number" class="form-control" id="sokAmount" placeholder="V√≠ d·ª•: 1000">
                    </div>
                    <div class="col-md-8">
                        <label for="fiatDetails" class="form-label">Th√¥ng tin nh·∫≠n ti·ªÅn (VNƒê)</label>
                        <input type="text" class="form-control" id="fiatDetails" placeholder="V√≠ d·ª•: 250,000 VND - VCB 0123456789 - NGUYEN VAN A">
                    </div>
                </div>
                <button class="btn btn-success mt-3" onclick="createSellOrder()">T·∫°o L·ªánh B√°n</button>
            </div>
        </div>

        <!-- Danh s√°ch l·ªánh ƒëang m·ªü -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">C√°c L·ªánh ƒêang M·ªü B√°n</h5>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ng∆∞·ªùi B√°n</th>
                            <th>S·ªë L∆∞·ª£ng (SOK)</th>
                            <th>Th√¥ng Tin Thanh To√°n</th>
                            <th>H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="open-orders-table">
                        <!-- D·ªØ li·ªáu ƒë∆∞·ª£c n·∫°p b·∫±ng JS -->
                    </tbody>
                </table>
                 <div class="text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="loadOpenOrders()">L√†m m·ªõi danh s√°ch</button>
                </div>
            </div>
        </div>
    </div>

<script>
// Khai b√°o bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u th√¥ng tin v√≠
let userWallet = {
    privateKey: null,
    address: null,
    balance: 0
};

// H√†m ti·ªán √≠ch ƒë·ªÉ g·ªçi API
async function apiCall(endpoint, method = 'GET', body = null) {
    const options = {
        method,
        headers: { 'Content-Type': 'application/json' }
    };
    if (body) {
        options.body = JSON.stringify(body);
    }
    const response = await fetch(endpoint, options);
    if (!response.ok) {
        const errorData = await response.json();
        alert(`L·ªói: ${errorData.error || 'C√≥ l·ªói x·∫£y ra'}`);
        throw new Error(errorData.error);
    }
    return response.json();
}

// N·∫°p th√¥ng tin v√≠ t·ª´ Private Key
async function loadMyWallet() {
    const pk_pem = document.getElementById('privateKeyInput').value;
    if (!pk_pem) {
        alert('Vui l√≤ng nh·∫≠p Private Key.');
        return;
    }
    try {
        // L·∫•y ƒë·ªãa ch·ªâ v√≠ t·ª´ key (Gi·∫£ ƒë·ªãnh server ch√≠nh c√≥ API n√†y)
        const walletData = await apiCall('http://127.0.0.1:9000/api/wallet_from_pk', 'POST', { private_key_pem: pk_pem });
        userWallet.privateKey = pk_pem;
        userWallet.address = walletData.address;
        
        // L·∫•y s·ªë d∆∞ (Gi·∫£ ƒë·ªãnh server ch√≠nh c√≥ API n√†y)
        const balanceData = await apiCall(`http://127.0.0.1:9000/api/get_balance/${userWallet.address}`);
        userWallet.balance = balanceData.balance;

        // Hi·ªÉn th·ªã th√¥ng tin
        document.getElementById('walletAddress').innerText = userWallet.address;
        document.getElementById('walletBalance').innerText = userWallet.balance;
        document.getElementById('walletInfo').style.display = 'block';

    } catch (error) {
        console.error(error);
    }
}

// N·∫°p danh s√°ch c√°c l·ªánh ƒëang m·ªü
async function loadOpenOrders() {
    const tableBody = document.getElementById('open-orders-table');
    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
    try {
        const orders = await apiCall('/api/v1/p2p/orders/list');
        tableBody.innerHTML = '';
        if (orders.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Ch∆∞a c√≥ l·ªánh b√°n n√†o.</td></tr>';
            return;
        }
        orders.forEach(order => {
            const row = `
                <tr>
                    <td class="text-monospace">${order.seller_address.substring(0, 12)}...</td>
                    <td>${order.sok_amount}</td>
                    <td>${order.fiat_details}</td>
                    <td><button class="btn btn-success btn-sm" onclick="acceptOrder('${order.id}')">Mua</button></td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    } catch (error) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Kh√¥ng th·ªÉ t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu.</td></tr>';
        console.error(error);
    }
}


// Ch·∫•p nh·∫≠n m·ªôt l·ªánh mua
async function acceptOrder(orderId) {
    if (!userWallet.address) {
        alert('Vui l√≤ng n·∫°p v√≠ c·ªßa b·∫°n tr∆∞·ªõc khi th·ª±c hi·ªán giao d·ªãch!');
        return;
    }
    
    const isConfirmed = confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën mua SOK t·ª´ l·ªánh n√†y kh√¥ng? H√†nh ƒë·ªông n√†y s·∫Ω th√¥ng b√°o cho ng∆∞·ªùi b√°n.');
    if (isConfirmed) {
        try {
            const result = await apiCall(`/api/v1/p2p/orders/${orderId}/accept`, 'POST', { buyer_address: userWallet.address });
            alert(result.message);
            // C√≥ th·ªÉ th√™m logic ƒë·ªÉ qu·∫£n l√Ω c√°c l·ªánh ƒëang ch·ªù thanh to√°n
        } catch (error) {
            console.error(error);
        }
    }
}

// Worker t·∫°o l·ªánh b√°n
async function createSellOrder() {
    // Lu·ªìng n√†y ph·ª©c t·∫°p h∆°n, y√™u c·∫ßu ng∆∞·ªùi d√πng ph·∫£i g·ª≠i SOK v√†o v√≠ k√Ω qu·ªπ tr∆∞·ªõc.
    // T·∫°m th·ªùi ƒë·ªÉ d∆∞·ªõi d·∫°ng th√¥ng b√°o.
    alert('Ch·ª©c nƒÉng "T·∫°o L·ªánh B√°n" c·∫ßn m·ªôt quy tr√¨nh ph·ª©c t·∫°p h∆°n (k√Ω qu·ªπ SOK tr∆∞·ªõc).\nƒê√¢y l√† t√≠nh nƒÉng s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn trong c√°c phi√™n b·∫£n sau.');
}


// T·ª± ƒë·ªông n·∫°p danh s√°ch khi trang ƒë∆∞·ª£c t·∫£i
document.addEventListener('DOMContentLoaded', loadOpenOrders);
</script>

</body>
</html>