<!-- N·ªòI DUNG C·ª¶A FILE templates/faucet.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì ∆Ø·ªõc Nguy·ªán - Œ£OK Chain</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-accent: #6f42c1; }
        body { background-color: #f0f2f5; font-family: 'Poppins', sans-serif; }
        .wallet-card { background-color: #fff; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07); padding: 2rem; border: 1px solid #e9ecef; }
        .wallet-info { word-break: break-all; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; background-color: #f8f9fa; padding: 12px; border-radius: 10px; border: 1px solid #e9ecef; }
        .btn { border-radius: 12px; font-weight: 500; transition: all 0.2s ease-in-out; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-5 shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/"><strong>Œ£OK</strong> Chain</a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-arrow-left-circle me-1"></i>V·ªÅ B·∫£ng ƒëi·ªÅu khi·ªÉn ch√≠nh</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="text-center mb-4">
            <h1><i class="bi bi-droplet-half text-primary"></i> H·ªì ∆Ø·ªõc Nguy·ªán</h1>
            <p class="lead text-muted">M·ªói ng√†y m·ªôt l·∫ßn, h√£y th·∫£ ƒë·ªìng xu v√† nh·∫≠n m·ªôt ch√∫t may m·∫Øn t·ª´ Sokchain.</p>
        </div>
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="wallet-card text-center" id="faucet-wallet-container">
                    <!-- Giao di·ªán v√≠ s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                </div>
                <div class="card mt-4" id="faucet-main-card" style="display:none;">
                    <div class="card-body text-center p-4">
                        <h5 class="card-title">Ph·∫ßn th∆∞·ªüng h√¥m nay</h5>
                        <p class="display-4 fw-bold text-success" id="faucet-reward-amount">... SOK</p>
                        <button class="btn btn-primary btn-lg w-100" id="claim-faucet-btn" data-action="claim-faucet">
                            <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                            <span class="btn-text"><i class="bi bi-coin me-2"></i>Th·∫£ ƒë·ªìng xu & ∆Ø·ªõc nguy·ªán</span>
                        </button>
                        <div id="faucet-cooldown-timer" class="mt-3 text-muted" style="display: none;">
                            B·∫°n c√≥ th·ªÉ ∆∞·ªõc nguy·ªán l·∫°i sau: <strong id="faucet-timer-display">...</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ƒê∆Ø·ª¢C TH√äM T·ª™ DASHBOARD.HTML -->
    <div class="modal fade" id="backupModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">üö® C·∫¢NH B√ÅO AN NINH</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p><strong>H√£y sao ch√©p v√† c·∫•t gi·ªØ KH√ìA B√ç M·∫¨T ·ªü n∆°i an to√†n. N·∫øu l√†m m·∫•t, b·∫°n s·∫Ω m·∫•t quy·ªÅn truy c·∫≠p v√†o v√≠ vƒ©nh vi·ªÖn.</strong></p><textarea id="modal-private-key" class="form-control" readonly style="height: 180px;"></textarea></div><div class="modal-footer"><span id="modal-copied-message" class="text-success me-auto" style="display:none;">ƒê√£ sao ch√©p!</span><button type="button" class="btn btn-success" data-action="copy-and-close-modal">Sao ch√©p & ƒê√≥ng</button></div></div></div></div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3"><div id="appToast" class="toast" role="alert"><div class="toast-header"><strong class="me-auto" id="toast-title">Th√¥ng b√°o</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div class="toast-body" id="toast-body"></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/transaction.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let state = { userWallet: null, unlockedPrivateKey: null };
        
        // --- KH·ªûI T·∫†O C√ÅC BI·∫æN CHO MODAL V√Ä TOAST ---
        const appToast = new bootstrap.Toast(document.getElementById('appToast'));
        const backupModalEl = document.getElementById('backupModal');
        const backupModal = new bootstrap.Modal(backupModalEl);

        const api = {
            async request(endpoint, method = 'GET', body = null) {
                try {
                    const options = { method, headers: { 'Content-Type': 'application/json' } };
                    if (body) options.body = JSON.stringify(body);
                    const response = await fetch(endpoint, options);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.');
                    return data;
                } catch (error) {
                    showToast(`L·ªói: ${error.message}`, 'L·ªói API');
                    throw error;
                }
            }
        };

        function showToast(message, title = 'Th√¥ng b√°o') {
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-body').innerText = message;
            appToast.show();
        }

        function renderAll() {
            renderWallet();
            renderFaucet();
        }

        // --- H√ÄM RENDER WALLET ƒê√É ƒê∆Ø·ª¢C N√ÇNG C·∫§P ---
        function renderWallet() {
            const container = document.getElementById('faucet-wallet-container');
            if (state.userWallet) {
                // Gi·ªØ nguy√™n giao di·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p
                container.innerHTML = `<h5 class="text-success"><i class="bi bi-wallet-fill"></i> V√≠ ƒë√£ M·ªü kh√≥a</h5><p class="wallet-info">${state.userWallet.address}</p><button class="btn btn-sm btn-outline-danger mt-3" data-action="logout"><i class="bi bi-lock-fill"></i> Kh√≥a V√≠</button>`;
            } else {
                // √Åp d·ª•ng giao di·ªán m·ªõi t·ª´ dashboard.html khi ch∆∞a ƒëƒÉng nh·∫≠p
                container.innerHTML = `<h5><i class="bi bi-unlock-fill"></i> M·ªü kh√≥a V√≠</h5>
                                       <p class="small text-muted">D√πng v√≠ ƒë·ªÉ t∆∞∆°ng t√°c.</p>
                                       <button class="btn btn-sm btn-success w-100 mb-2" data-action="create-wallet">
                                           <i class="bi bi-plus-lg"></i> T·∫°o V√≠ M·ªõi
                                       </button>
                                       <div class="mb-2">
                                           <label class="form-label small">Ho·∫∑c d√°n Private Key:</label>
                                           <textarea class="form-control form-control-sm import-pk-pem" rows="4"></textarea>
                                       </div>
                                       <button class="btn btn-sm btn-primary w-100" data-action="import-wallet">
                                           <i class="bi bi-key-fill"></i> M·ªü kh√≥a
                                       </button>`;
            }
        }
        
        let faucetCooldownInterval = null;
        async function renderFaucet() {
            const faucetCard = document.getElementById('faucet-main-card');
            if (!state.userWallet) {
                faucetCard.style.display = 'none';
                return;
            }
            faucetCard.style.display = 'block';

            const claimBtn = document.getElementById('claim-faucet-btn');
            const timerDisplay = document.getElementById('faucet-cooldown-timer');
            const timerText = document.getElementById('faucet-timer-display');

            try {
                const status = await api.request(`/api/v1/faucet/status/${state.userWallet.address}`);
                document.getElementById('faucet-reward-amount').textContent = `${parseFloat(status.faucet_amount).toFixed(2)} SOK`;
                
                if (status.can_claim) {
                    claimBtn.disabled = false;
                    claimBtn.querySelector('.btn-text').textContent = 'Th·∫£ ƒë·ªìng xu & ∆Ø·ªõc nguy·ªán';
                    timerDisplay.style.display = 'none';
                    if (faucetCooldownInterval) clearInterval(faucetCooldownInterval);
                } else {
                    claimBtn.disabled = true;
                    timerDisplay.style.display = 'block';
                    
                    let secondsLeft = status.seconds_until_next_claim;
                    
                    const updateTimer = () => {
                        if (secondsLeft <= 0) {
                            clearInterval(faucetCooldownInterval);
                            renderFaucet();
                        } else {
                            const h = Math.floor(secondsLeft / 3600).toString().padStart(2, '0');
                            const m = Math.floor((secondsLeft % 3600) / 60).toString().padStart(2, '0');
                            const s = (secondsLeft % 60).toString().padStart(2, '0');
                            timerText.textContent = `${h}:${m}:${s}`;
                            claimBtn.querySelector('.btn-text').textContent = `Vui l√≤ng ch·ªù...`;
                            secondsLeft--;
                        }
                    };

                    if (faucetCooldownInterval) clearInterval(faucetCooldownInterval);
                    updateTimer();
                    faucetCooldownInterval = setInterval(updateTimer, 1000);
                }
            } catch (e) {
                claimBtn.disabled = true;
                timerDisplay.textContent = "L·ªói khi ki·ªÉm tra tr·∫°ng th√°i.";
            }
        }

        // --- B·ªò X·ª¨ L√ù S·ª∞ KI·ªÜN ƒê√É ƒê∆Ø·ª¢C HO√ÄN THI·ªÜN ---
        document.body.addEventListener('click', async (event) => {
            const button = event.target.closest('button');
            if (!button || !button.dataset.action) return;
            const action = button.dataset.action;

            switch(action) {
                case 'create-wallet': {
                    const data = await api.request('/api/create_wallet', 'POST');
                    backupModalEl.dataset.walletInfo = JSON.stringify(data);
                    document.getElementById('modal-private-key').value = data.private_key_pem;
                    backupModal.show();
                    break;
                }
                case 'copy-and-close-modal': {
                    const pkTextarea = document.getElementById('modal-private-key');
                    const copiedMessage = document.getElementById('modal-copied-message');
                    navigator.clipboard.writeText(pkTextarea.value).then(() => {
                        copiedMessage.style.display = 'inline';
                        setTimeout(() => {
                            const walletData = JSON.parse(backupModalEl.dataset.walletInfo || '{}');
                            state.userWallet = { address: walletData.address };
                            state.unlockedPrivateKey = walletData.private_key_pem;
                            backupModal.hide();
                            renderAll();
                            showToast("ƒê√£ t·∫°o v√≠ v√† sao ch√©p Private Key!", "Th√†nh c√¥ng");
                        }, 1000);
                    }).catch(err => showToast('L·ªói sao ch√©p, vui l√≤ng sao ch√©p th·ªß c√¥ng.', 'L·ªói'));
                    break;
                }
                case 'import-wallet': {
                    // S·ª≠ d·ª•ng class selector ƒë·ªÉ t√¨m ƒë√∫ng textarea
                    const pkPem = button.parentElement.querySelector('.import-pk-pem').value.trim();
                    if (!pkPem) return showToast("Vui l√≤ng nh·∫≠p Private Key.", "C·∫£nh b√°o");
                    try {
                        const walletData = await api.request('/api/wallet_from_pk', 'POST', { private_key_pem: pkPem });
                        state.userWallet = { address: walletData.address };
                        state.unlockedPrivateKey = pkPem;
                        renderAll();
                        showToast("V√≠ ƒë√£ ƒë∆∞·ª£c m·ªü kh√≥a!", "Th√†nh c√¥ng");
                    } catch (e) {}
                    break;
                }
                case 'logout': {
                    state = { userWallet: null, unlockedPrivateKey: null };
                    if (faucetCooldownInterval) clearInterval(faucetCooldownInterval); // D·ª´ng timer khi logout
                    renderAll();
                    break;
                }
                case 'claim-faucet': {
                    const spinner = button.querySelector('.spinner-border');
                    const btnText = button.querySelector('.btn-text');
                    
                    button.disabled = true;
                    spinner.style.display = 'inline-block';
                    btnText.style.display = 'none';

                    try {
                        const result = await api.request('/api/v1/faucet/claim', 'POST', { address: state.userWallet.address });
                        showToast(result.message, "Th√†nh c√¥ng!");
                        setTimeout(() => {
                            showToast("S·ªë d∆∞ c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau √≠t ph√∫t.", "Th√¥ng b√°o");
                        }, 3000);
                    } catch(e) {
                        // L·ªói ƒë√£ ƒë∆∞·ª£c hi·ªÉn th·ªã
                    } finally {
                        spinner.style.display = 'none';
                        btnText.style.display = 'inline-block';
                        renderFaucet(); // Lu√¥n render l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                    }
                    break;
                }
            }
        });

        function initialize() {
            renderAll();
        }
        initialize();
    });
    </script>
</body>
</html>