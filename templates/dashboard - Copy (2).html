<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Œ£OK Chain - B·∫£ng ƒêi·ªÅu Khi·ªÉn H·ª£p Nh·∫•t</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary-accent: #6f42c1;
            --primary-accent-hover: #5a37a0; 
            --border-color: rgba(255, 255, 255, 0.2); 
            --border-radius-main: 16px;
            --box-shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.1);
            --neon-glow-color: #a052c8;
        }

        @keyframes aurora-background {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes neon-ripple-glow {
            0% { box-shadow: 0 0 5px var(--neon-glow-color), 0 0 10px var(--neon-glow-color), 0 0 15px var(--primary-accent); }
            50% { box-shadow: 0 0 10px var(--primary-accent), 0 0 20px var(--neon-glow-color), 0 0 30px var(--primary-accent); }
            100% { box-shadow: 0 0 5px var(--neon-glow-color), 0 0 10px var(--neon-glow-color), 0 0 15px var(--primary-accent); }
        }

        @keyframes sok-wiggle {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(4deg) translateY(-2px); }
            50% { transform: rotate(-4deg); }
            75% { transform: rotate(2deg) translateY(-1px); }
            100% { transform: rotate(0deg); }
        }
        
        @keyframes move-soul {
            0% { transform: translate(10vw, 10vh) scale(1); opacity: 0.7; }
            15% { transform: translate(40vw, 60vh) scale(1.2); opacity: 0.4; }
            30% { transform: translate(80vw, 80vh) scale(0.9); opacity: 0.8; }
            45% { transform: translate(90vw, 20vh) scale(1.1); opacity: 0.5; }
            60% { transform: translate(50vw, 5vh) scale(1); opacity: 0.9; }
            75% { transform: translate(20vw, 90vh) scale(1.3); opacity: 0.6; }
            90% { transform: translate(5vw, 50vh) scale(1); opacity: 0.8; }
            100% { transform: translate(10vw, 10vh) scale(1); opacity: 0.7; }
        }

        #soul-particle {
            position: fixed;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(160, 82, 200, 0.6) 40%, rgba(111, 66, 193, 0.3) 100%);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(160, 82, 200, 0.8), 0 0 25px rgba(255, 255, 255, 0.5) inset;
            z-index: 999;
            pointer-events: none; /* Quan tr·ªçng: ƒë·ªÉ kh√¥ng ch·∫∑n c√°c click chu·ªôt */
            animation: move-soul 45s linear infinite;
            will-change: transform, opacity; /* G·ª£i √Ω cho tr√¨nh duy·ªát ƒë·ªÉ t·ªëi ∆∞u hi·ªáu nƒÉng */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #0b1a2b, #1d2c67, #3b4a8a, #4a8da8, #2ca58d, #8a4a7c, #4a2c5a);
            background-size: 400% 400%;
            animation: aurora-background 18s ease infinite;
            color: #333;
        }
        
        #sok-brand-text {
            display: inline-block;
        }
        #sok-brand-text.animate-wiggle {
            animation: sok-wiggle 0.5s ease-in-out;
        }

        .navbar, .tab-content, .wallet-card, .card, .main-content-card, .mining-card {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); 
            border: 1px solid var(--border-color);
        }

        .navbar { 
            box-shadow: 0 2px 10px rgba(0,0,0,.1); 
            background-color: rgba(255, 255, 255, 0.9);
        }

        .main-container { max-width: 1200px; margin: auto; }
        .nav-tabs { border-bottom: none; }
        .nav-tabs .nav-link { 
            font-weight: 500; 
            color: var(--primary-accent); 
            border: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0 !important;
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-accent);
            border-color: var(--primary-accent);
            background-color: rgba(255, 255, 255, 0.95) !important;
            box-shadow: 0 -4px 15px rgba(111, 66, 193, 0.2);
            transform: translateY(-2px);
        }
        
        .tab-content { padding: 2rem; border-top: none; border-radius: 0 0 var(--border-radius-main) var(--border-radius-main); min-height: 70vh; }
        .page-header { text-align: center; margin-bottom: 2rem; }
        .page-header h1 { font-weight: 700; color: #111; }
        .page-header .lead { color: #555 !important; }

        .wallet-card { border-radius: var(--border-radius-main); box-shadow: var(--box-shadow-soft); padding: 2rem; }
        .wallet-info { 
            word-break: break-all; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; 
            background-color: #f0f2f5; 
            padding: 12px; border-radius: 10px; border: 1px solid #ddd;
        }
        .btn { border-radius: 12px; font-weight: 500; transition: all 0.2s ease-in-out; }
        
        .stat-card { 
            text-align: center; padding: 15px; background-color: rgba(248, 249, 250, 0.8); 
            border-radius: var(--border-radius-main); transition: transform 0.2s, box-shadow 0.3s ease;
            border: 1px solid transparent;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.25);
            border-color: rgba(111, 66, 193, 0.3);
        }
        
        .stat-icon { font-size: 2rem; color: var(--primary-accent); transition: color 0.3s ease; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: #222; }
        .stat-label { font-size: 0.8rem; text-transform: uppercase; color: #666; }
        
        .worker-list, #explorer-content { max-height: 500px; overflow-y: auto; }
        .worker-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background-color: rgba(240, 242, 245, 0.9); border-radius: 10px; margin-bottom: 8px; }
        .worker-address { font-family: 'Courier New', Courier, monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-online { background-color: #198754; animation: pulse 2s infinite; }
        .status-offline { background-color: #6c757d; }
        .status-busy { background-color: #ffc107; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(25,135,84,0.7); } 70% { box-shadow: 0 0 0 8px rgba(25,135,84,0); } 100% { box-shadow: 0 0 0 0 rgba(25,135,84,0); } }
        
        #website-list li { background-color: #f8f9fa; margin-bottom: 0.75rem; padding: 1rem 1.5rem; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .table-hover tbody tr:hover { background-color: rgba(248, 249, 250, 0.7); cursor: pointer; }
        
        .block-card { background: #ffffff; border: 1px solid #e0e6ed; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .block-header { padding: 10px 15px; border-bottom: 1px solid #e0e6ed; font-weight: bold; font-size: 1.1rem; color: #2980b9; }
        .block-details { padding: 15px; font-size: 0.8rem; }
        .tx-item { padding: 10px; border-top: 1px dashed #e0e6ed; }
        
        #ai-chat-bubble {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background-image: linear-gradient(45deg, var(--primary-accent), var(--neon-glow-color));
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: white; cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.3s ease; z-index: 1050;
            animation: neon-ripple-glow 4s infinite ease-in-out;
        }
        #ai-chat-bubble:hover { transform: scale(1.1); }
        
        #ai-chat-window { position: fixed; bottom: 100px; right: 25px; width: 350px; max-width: 90vw; height: 500px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: var(--border-radius-main); box-shadow: 0 5px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: opacity 0.3s, transform 0.3s; transform: translateY(20px); opacity: 0; z-index: 1040; pointer-events: none; border: 1px solid rgba(255,255,255,0.2); }
        #ai-chat-window.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .chat-header { padding: 1rem; background: var(--primary-accent); color: white; border-radius: var(--border-radius-main) var(--border-radius-main) 0 0; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.5; white-space: pre-wrap; }
        .user-message { background-color: #e9ecef; color: #333; border-bottom-right-radius: 4px; align-self: flex-end; }
        .ai-message { background-color: var(--primary-accent); color: white; border-bottom-left-radius: 4px; align-self: flex-start; }
        .chat-footer { padding: 0.5rem 1rem; border-top: 1px solid var(--border-color); }
    </style>
</head>
<body>
    <div id="soul-particle"></div>
    <nav class="navbar navbar-expand-lg mb-4">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="/static/logo.png" alt="Sokchain Logo" style="height: 35px; margin-right: 10px;">
                <strong><span id="sok-brand-text">Œ£OK</span></strong> Chain Web3 AI integration
            </a>
        </div>
    </nav>
    <div class="main-container container">
        <!-- [START] B·ªï sung Tab History v√†o thanh ƒëi·ªÅu h∆∞·ªõng -->
        <ul class="nav nav-tabs" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboard-pane" type="button" role="tab"><i class="bi bi-speedometer2 me-1"></i>Cpanel</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#guide-pane" type="button" role="tab"><i class="bi bi-book-half me-1"></i>H∆∞·ªõng d·∫´n</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#manage-pane" type="button" role="tab"><i class="bi bi-globe-americas me-1"></i>Qu·∫£n l√Ω Website</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#market-pane" type="button" role="tab"><i class="bi bi-cart3 me-1"></i>Ch·ª£ P2P</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab"><i class="bi bi-clock-history me-1"></i>L·ªãch s·ª≠ GD</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#explorer-pane" type="button" role="tab"><i class="bi bi-search me-1"></i>Explorer</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#mining-pane" type="button" role="tab"><i class="bi bi-pickaxe me-1"></i>Khai th√°c</button></li>
        </ul>
        <!-- [END] B·ªï sung Tab History v√†o thanh ƒëi·ªÅu h∆∞·ªõng -->

        <div class="tab-content" id="myTabContent">
            <!-- Cpanel Tab -->
            <div class="tab-pane fade show active" id="dashboard-pane" role="tabpanel">
                <div class="page-header"><h1>Cpanel</h1><p class="lead text-muted">Theo d√µi s·ª©c kh·ªèe v√† c√°c ho·∫°t ƒë·ªông ch√≠nh c·ªßa to√†n b·ªô h·ªá sinh th√°i SOK.</p></div>
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg-2"><div class="stat-card"><div class="stat-icon"><i class="bi bi-people-fill"></i></div><div id="active-workers" class="stat-value">...</div><div class="stat-label">Worker Online</div></div></div>
                    <div class="col-6 col-md-4 col-lg-2"><div class="stat-card"><div class="stat-icon"><i class="bi bi-globe2"></i></div><div id="total-websites" class="stat-value">...</div><div class="stat-label">T·ªïng Website</div></div></div>
                    <div class="col-6 col-md-4 col-lg-2"><div class="stat-card"><div class="stat-icon"><i class="bi bi-eye-fill"></i></div><div id="views-completed" class="stat-value">...</div><div class="stat-label">L∆∞·ª£t xem</div></div></div>
                    <div class="col-6 col-md-4 col-lg-2"><div class="stat-card"><div class="stat-icon"><i class="bi bi-bricks"></i></div><div id="blockchain-height" class="stat-value">...</div><div class="stat-label">Chi·ªÅu cao Chain</div></div></div>
                    <div class="col-6 col-md-4 col-lg-2"><div class="stat-card"><div class="stat-icon"><i class="bi bi-arrow-left-right"></i></div><div id="p2p-orders" class="stat-value">...</div><div class="stat-label">L·ªánh P2P</div></div></div>
                </div>
                <div class="row g-4"><div class="col-lg-6"><h5 class="mb-3"><i class="bi bi-link-45deg text-primary"></i> D·ªãch V·ª• Backlink thanh to√°n b·∫±ng SOK</h5><ul id="backlink-worker-list" class="worker-list"><p class="text-center mt-3">Truy v·∫•n SOK bot</p></ul></div><div class="col-lg-6"><h5 class="mb-3"><i class="bi bi-person-workspace text-info"></i> Th·ª£ ƒë√†o v√† Viewer</h5><ul id="view-worker-list" class="worker-list"><p class="text-center mt-3">Truy v·∫•n SOK bot</p></ul></div></div>
            </div>
            
            <!-- Guide Tab -->
            <div class="tab-pane fade" id="guide-pane" role="tabpanel">
                <div class="page-header">
                    <h1><i class="bi bi-book-half"></i> H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng SOK Chain</h1>
                    <p class="lead text-muted">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi h·ªá sinh th√°i Œ£OK Chain! D∆∞·ªõi ƒë√¢y l√† c√°c b∆∞·ªõc ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                </div>
                <div class="accordion" id="guide-accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                <strong>B∆∞·ªõc 1: T·∫°o ho·∫∑c M·ªü kh√≥a V√≠ SOK</strong>
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#guide-accordion">
                            <div class="accordion-body">
                                <p>V√≠ SOK l√† c·ª≠a ng√µ ƒë·ªÉ b·∫°n t∆∞∆°ng t√°c v·ªõi m·ªçi t√≠nh nƒÉng c·ªßa h·ªá th·ªëng. B·∫°n c√≥ th·ªÉ t√¨m th·∫•y khu v·ª±c qu·∫£n l√Ω v√≠ ·ªü b·∫•t k·ª≥ tab ch·ª©c nƒÉng n√†o nh∆∞ "Qu·∫£n l√Ω Website", "Ch·ª£ P2P", ho·∫∑c "Staking".</p>
                                <ul>
                                    <li><strong>T·∫°o V√≠ M·ªõi:</strong> Nh·∫•n n√∫t "T·∫°o V√≠ M·ªõi". M·ªôt c·ª≠a s·ªï c·∫£nh b√°o s·∫Ω hi·ªán ra, ch·ª©a <strong>KH√ìA B√ç M·∫¨T (Private Key)</strong> c·ªßa b·∫°n.</li>
                                    <li><strong><span class="text-danger">QUAN TR·ªåNG:</span></strong> H√£y sao ch√©p v√† l∆∞u tr·ªØ Kh√≥a B√≠ M·∫≠t n√†y ·ªü m·ªôt n∆°i C·ª∞C K·ª≤ an to√†n (v√≠ d·ª•: tr√¨nh qu·∫£n l√Ω m·∫≠t kh·∫©u, ghi ra gi·∫•y c·∫•t ƒëi). N·∫øu l√†m m·∫•t kh√≥a n√†y, b·∫°n s·∫Ω m·∫•t quy·ªÅn truy c·∫≠p v√†o v√≠ v√† to√†n b·ªô t√†i s·∫£n trong ƒë√≥ vƒ©nh vi·ªÖn.</li>
                                    <li><strong>M·ªü kh√≥a V√≠:</strong> N·∫øu ƒë√£ c√≥ Kh√≥a B√≠ M·∫≠t, h√£y d√°n n√≥ v√†o √¥ "Ho·∫∑c d√°n Private Key" v√† nh·∫•n "M·ªü kh√≥a".</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                <strong>B∆∞·ªõc 2: C√≥ SOK trong v√≠</strong>
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#guide-accordion">
                            <div class="accordion-body">
                                C√≥ hai c√°ch ch√≠nh ƒë·ªÉ s·ªü h·ªØu SOK:
                                <ol>
                                    <li><strong>Mua tr√™n Ch·ª£ P2P:</strong> V√†o tab "Ch·ª£ P2P", b·∫°n s·∫Ω th·∫•y danh s√°ch nh·ªØng ng∆∞·ªùi ƒëang b√°n SOK. Ch·ªçn m·ªôt l·ªánh b√°n ph√π h·ª£p, nh·∫•n "Mua", sau ƒë√≥ chuy·ªÉn kho·∫£n theo th√¥ng tin ng∆∞·ªùi b√°n cung c·∫•p ƒë·ªÉ nh·∫≠n SOK.</li>
                                    <li><strong>Khai th√°c (Mining):</strong> V√†o tab "Khai th√°c" v√† l√†m theo h∆∞·ªõng d·∫´n ƒë·ªÉ t·∫£i v·ªÅ c√¥ng c·ª• khai th√°c. B·∫±ng c√°ch ƒë√≥ng g√≥p s·ª©c m·∫°nh x·ª≠ l√Ω c·ªßa m√°y t√≠nh, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c ph·∫ßn th∆∞·ªüng l√† SOK.</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                <strong>B∆∞·ªõc 3: S·ª≠ d·ª•ng v√† Ki·∫øm th√™m SOK</strong>
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#guide-accordion">
                            <div class="accordion-body">
                                <h5>S·ª≠ d·ª•ng SOK:</h5>
                                <p>V√†o tab <strong>"Qu·∫£n l√Ω Website"</strong>. T·∫°i ƒë√¢y, b·∫°n c√≥ th·ªÉ:</p>
                                <ul>
                                    <li>Th√™m URL website c·ªßa b·∫°n v√†o h·ªá th·ªëng.</li>
                                    <li>N·∫°p SOK v√†o "Kho b·∫°c" ƒë·ªÉ b·∫Øt ƒë·∫ßu c√°c chi·∫øn d·ªãch qu·∫£ng c√°o, tƒÉng l∆∞·ª£t xem cho website c·ªßa m√¨nh.</li>
                                </ul>
                                <h5>Ki·∫øm th√™m SOK:</h5>
                                <ul>
                                    <li><strong>B√°n tr√™n Ch·ª£ P2P:</strong> N·∫øu b·∫°n c√≥ SOK v√† mu·ªën b√°n, h√£y v√†o tab "Ch·ª£ P2P", t·∫°o l·ªánh b√°n v√† cung c·∫•p th√¥ng tin nh·∫≠n ti·ªÅn c·ªßa b·∫°n.</li>
                                    <li><strong>Khai th√°c:</strong> Nh∆∞ ƒë√£ ƒë·ªÅ c·∫≠p ·ªü B∆∞·ªõc 2, ƒë√¢y l√† c√°ch tham gia tr·ª±c ti·∫øp v√†o vi·ªác b·∫£o m·∫≠t m·∫°ng l∆∞·ªõi v√† nh·∫≠n th∆∞·ªüng.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                     <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFour">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour">
                                <strong>Tr·ª£ l√Ω AI v√† c√°c t√≠nh nƒÉng kh√°c</strong>
                            </button>
                        </h2>
                        <div id="collapseFour" class="accordion-collapse collapse" data-bs-parent="#guide-accordion">
                            <div class="accordion-body">
                                <ul>
                                    <li><strong>Tr·ª£ l√Ω AI:</strong> Bong b√≥ng chat ·ªü g√≥c d∆∞·ªõi b√™n ph·∫£i l√† Tr·ª£ l√Ω AI c·ªßa SOK Chain. Khi b·∫°n ƒë√£ m·ªü kh√≥a v√≠, n√≥ c√≥ th·ªÉ t√≥m t·∫Øt th√¥ng tin t√†i kho·∫£n, gi·∫£i ƒë√°p th·∫Øc m·∫Øc v√† h∆∞·ªõng d·∫´n b·∫°n s·ª≠ d·ª•ng c√°c t√≠nh nƒÉng.</li>
                                    <li><strong>Explorer:</strong> Tab "Explorer" cho ph√©p b·∫°n xem c√°c giao d·ªãch v√† kh·ªëi ƒëang ƒë∆∞·ª£c t·∫°o ra tr√™n blockchain m·ªôt c√°ch minh b·∫°ch.</li>
                                </ul>
                                <div class="alert alert-info mt-3">
                                    <i class="bi bi-info-circle-fill"></i> <strong>M·∫πo:</strong> H√£y lu√¥n ki·ªÉm tra c√°c th√¥ng b√°o nh·ªè (toast) hi·ªán l√™n ·ªü g√≥c m√†n h√¨nh sau m·ªói h√†nh ƒë·ªông ƒë·ªÉ bi·∫øt tr·∫°ng th√°i x·ª≠ l√Ω.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Website Tab -->
            <div class="tab-pane fade" id="manage-pane" role="tabpanel">
                <div class="page-header"><h1>üöÄ B·ªá ph√≥ng Qu·∫£ng c√°o</h1><p class="lead">Th√™m trang web, n·∫°p SOK v√† b·∫Øt ƒë·∫ßu chi·∫øn d·ªãch c·ªßa b·∫°n.</p></div>
                <div class="row"><div class="col-lg-8"><div class="main-content-card"><h3><i class="bi bi-globe-americas text-primary"></i> Website c·ªßa b·∫°n</h3><div class="mb-3"><input type="url" class="form-control" id="new-website-url" placeholder="https://your-website.com" disabled></div><button id="add-btn" class="btn btn-primary w-100" data-action="add-website" disabled><i class="bi bi-plus-circle-fill me-2"></i>Th√™m Website M·ªõi</button><hr class="my-4"><ul id="website-list" class="list-unstyled"><li class="text-center text-muted py-3">H√£y M·ªü kh√≥a V√≠ ƒë·ªÉ b·∫Øt ƒë·∫ßu!</li></ul></div></div><div class="col-lg-4"><div class="wallet-card" id="manage-wallet-container"></div><div class="wallet-card mt-3" id="funding-container" style="display:none;"></div></div></div>
            </div>

            <!-- P2P Market Tab -->
            <div class="tab-pane fade" id="market-pane" role="tabpanel">
                <div class="page-header"><h1>üõí Ch·ª£ Giao D·ªãch P2P SOK</h1><p class="lead">N∆°i mua b√°n SOK an to√†n v√† minh b·∫°ch gi·ªØa c√°c th√†nh vi√™n.</p></div>
                <div class="wallet-card mb-4" id="p2p-wallet-container"></div>
                <div class="card mb-4"><div class="card-body"><h5 class="card-title">T·∫°o L·ªánh B√°n M·ªõi</h5><div class="row g-3"><div class="col-md-4"><label class="form-label">S·ªë l∆∞·ª£ng SOK b√°n</label><input type="number" class="form-control" id="sokAmount" placeholder="1000"></div><div class="col-md-8"><label class="form-label">Th√¥ng tin nh·∫≠n ti·ªÅn (VNƒê)</label><input type="text" class="form-control" id="fiatDetails" placeholder="VCB 0123456789 - NGUYEN VAN A - 250,000 VND"></div></div><button class="btn btn-success mt-3" data-action="create-sell-order" disabled><i class="bi bi-send-plus-fill"></i> ƒêƒÉng b√°n</button></div></div>
                <div class="card"><div class="card-body"><h5 class="card-title">C√°c L·ªánh ƒêang M·ªü B√°n</h5><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>Ng∆∞·ªùi B√°n</th><th>S·ªë L∆∞·ª£ng (SOK)</th><th>Th√¥ng Tin Thanh To√°n</th><th>H√†nh ƒê·ªông</th></tr></thead><tbody id="open-orders-table"></tbody></table></div><div class="text-center mt-2"><button class="btn btn-sm btn-outline-primary" data-action="refresh-p2p-orders">L√†m m·ªõi</button></div></div></div>
            </div>
            
            <!-- [START] B·ªï sung n·ªôi dung Tab History -->
            <div class="tab-pane fade" id="history-pane" role="tabpanel">
                <div class="page-header">
                    <h1><i class="bi bi-clock-history"></i> L·ªãch s·ª≠ Giao d·ªãch</h1>
                    <p class="lead text-muted">T·∫•t c·∫£ c√°c giao d·ªãch ƒë·∫øn v√† ƒëi t·ª´ v√≠ c·ªßa b·∫°n.</p>
                </div>
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <div class="wallet-card h-100" id="history-wallet-container">
                        </div>
                    </div>
                    <div class="col-lg-4 d-flex align-items-center justify-content-center">
                         <button class="btn btn-primary w-100" data-action="refresh-history" disabled>
                            <i class="bi bi-arrow-clockwise me-2"></i>L√†m m·ªõi L·ªãch s·ª≠
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div id="history-list-container">
                            <p class="text-center text-muted p-5">
                                <i class="bi bi-unlock-fill fs-1"></i><br>
                                Vui l√≤ng m·ªü kh√≥a v√≠ ƒë·ªÉ xem l·ªãch s·ª≠ giao d·ªãch.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [END] B·ªï sung n·ªôi dung Tab History -->

            <!-- Explorer Tab -->
            <div class="tab-pane fade" id="explorer-pane" role="tabpanel">
                <div class="page-header"><h1>Tr√¨nh kh√°m ph√° chu·ªói</h1><p class="lead text-muted">Xem tr·ª±c ti·∫øp c√°c kh·ªëi v√† giao d·ªãch tr√™n m·∫°ng l∆∞·ªõi Sokchain.</p></div>
                <div class="d-flex justify-content-end mb-3"><button class="btn btn-primary btn-sm" data-action="refresh-explorer"><i class="bi bi-arrow-clockwise me-2"></i>L√†m m·ªõi</button></div>
                <div id="explorer-content"><p class="text-center text-muted">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ blockchain...</p></div>
            </div>

            <!-- Mining Tab -->
            <div class="tab-pane fade" id="mining-pane" role="tabpanel">
                <div class="page-header">
                    <h1><i class="bi bi-motherboard-fill"></i> B·∫£ng ƒëi·ªÅu khi·ªÉn Khai th√°c</h1>
                    <p class="lead text-muted">Qu·∫£n l√Ω v√† m·ªùi g·ªçi c·ªông ƒë·ªìng c√πng tham gia ƒë√≥ng g√≥p s·ª©c m·∫°nh cho m·∫°ng l∆∞·ªõi.</p>
                </div>

                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="mining-card h-100 p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="bi bi-server text-primary"></i> Tr·∫°ng th√°i Th·ª£ m·ªè Server</h5>
                            </div>
                            <div class="text-center">
                                <div id="miner-status-icon" class="mb-3">
                                    <i class="bi bi-question-circle-fill text-secondary" style="font-size: 5rem;"></i>
                                </div>
                                <p id="miner-status-text" class="mb-4 fs-5">ƒêang ki·ªÉm tra tr·∫°ng th√°i...</p>
                                <div class="px-md-4">
                                    <button id="miner-control-btn" class="btn btn-lg w-100" data-action="toggle-miner" disabled>
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        Vui l√≤ng ch·ªù
                                    </button>
                                </div>
                            </div>
                            <div class="alert alert-light border small mt-4 mb-0" style="background-color: rgba(230, 230, 230, 0.5) !important;">
                                <i class="bi bi-info-circle-fill me-1"></i>
                                ƒê√¢y l√† ti·∫øn tr√¨nh khai th√°c ch·∫°y tr√™n ch√≠nh m√°y ch·ªß n√†y. T√≠nh nƒÉng n√†y ch·ªâ d√†nh cho qu·∫£n tr·ªã vi√™n.
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="mining-card h-100 p-4">
                            <h5><i class="bi bi-people-fill text-success"></i> Tham gia v·ªõi M√°y t√≠nh c·ªßa b·∫°n</h5>
                            <p class="text-muted">
                                B·∫•t k·ª≥ ai c≈©ng c√≥ th·ªÉ ƒë√≥ng g√≥p s·ª©c m·∫°nh x·ª≠ l√Ω (CPU) cho m·∫°ng l∆∞·ªõi v√† nh·∫≠n ph·∫ßn th∆∞·ªüng SOK.
                            </p>
                            <ol class="list-group list-group-numbered">
                                <li class="list-group-item">
                                    <strong>T·∫£i Client Miner:</strong> T·∫£i v·ªÅ g√≥i ph·∫ßn m·ªÅm d√†nh cho th·ª£ m·ªè.
                                    <a href="https://www.mediafire.com/folder/4lkucjeou63zz/SOK_chain" target="_blank" class="btn btn-primary btn-sm w-100 mt-2">
                                        <i class="bi bi-download me-2"></i> T·∫£i v·ªÅ t·ª´ MediaFire
                                    </a>
                                </li>
                                <li class="list-group-item">
                                    <strong>Thi·∫øt l·∫≠p V√≠:</strong> - Khi kh·ªüi ƒë·ªông ·ª©ng d·ª•ng l·∫ßn ƒë·∫ßu, b·∫°n s·∫Ω ƒë∆∞·ª£c h∆∞·ªõng d·∫´n t·∫°o m·ªôt v√≠ m·ªõi ho·∫∑c m·ªü v√≠ ƒë√£ c√≥.
   - V√≠ c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c l∆∞u (m√£ h√≥a ho·∫∑c kh√¥ng) v√†o m·ªôt t·ªáp (v√≠ d·ª•: `my_smart_wallet.enc`).
   - C·ª∞C K·ª≤ QUAN TR·ªåNG: H√£y sao l∆∞u t·ªáp v√≠ v√† ghi nh·ªõ m·∫≠t kh·∫©u (n·∫øu c√≥) th·∫≠t c·∫©n th·∫≠n.<code>my_smart_wallet.enc</code>.
                                </li>
                                <li class="list-group-item">
                                    <strong>Ch·∫°y ti·∫øn tr√¨nh:</strong> M·ªü File, ch·∫°y l·ªánh sau v√† nh·∫≠p IP ho·∫∑c Domain c·ªßa server SOK khi ƒë∆∞·ª£c h·ªèi:
                                    <code class="d-block bg-dark text-white p-2 rounded mt-2">sok_super_AIO</code>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Modals and Toasts -->
    <div class="modal fade" id="backupModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">üö® C·∫¢NH B√ÅO AN NINH</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p><strong>H√£y sao ch√©p v√† c·∫•t gi·ªØ KH√ìA B√ç M·∫¨T ·ªü n∆°i an to√†n. N·∫øu l√†m m·∫•t, b·∫°n s·∫Ω m·∫•t quy·ªÅn truy c·∫≠p v√†o v√≠ vƒ©nh vi·ªÖn.</strong></p><textarea id="modal-private-key" class="form-control" readonly style="height: 180px;"></textarea></div><div class="modal-footer"><span id="modal-copied-message" class="text-success me-auto" style="display:none;">ƒê√£ sao ch√©p!</span><button type="button" class="btn btn-success" data-action="copy-and-close-modal">Sao ch√©p & ƒê√≥ng</button></div></div></div></div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3"><div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><strong class="me-auto" id="toast-title">Th√¥ng b√°o</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div class="toast-body" id="toast-body"></div></div></div>
    <div class="modal fade" id="p2pDepositModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title"><i class="bi bi-box-arrow-in-right me-2"></i>K√≠ch ho·∫°t L·ªánh b√°n P2P</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="fw-bold">L·ªánh b√°n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</p><p><strong>B∆∞·ªõc ti·∫øp theo:</strong> ƒê·ªÉ l·ªánh c·ªßa b·∫°n xu·∫•t hi·ªán tr√™n ch·ª£, b·∫°n c·∫ßn g·ª≠i (k√Ω qu·ªπ) ch√≠nh x√°c s·ªë SOK ƒë√£ rao b√°n v√†o ƒë·ªãa ch·ªâ v√≠ trung gian c·ªßa h·ªá th·ªëng.</p><hr><div class="mb-3"><label class="form-label small">S·ªë SOK c·∫ßn g·ª≠i:</label><div id="p2p-modal-amount" class="wallet-info fw-bold text-danger">...</div></div><div class="mb-3"><label class="form-label small">G·ª≠i ƒë·∫øn ƒë·ªãa ch·ªâ V√≠ K√Ω qu·ªπ:</label><div class="input-group"><input type="text" id="p2p-modal-address" class="form-control" readonly><button class="btn btn-outline-secondary" data-action="copy-p2p-address" title="Sao ch√©p ƒë·ªãa ch·ªâ"><i class="bi bi-clipboard-plus"></i></button></div></div><div class="alert alert-warning small"><i class="bi bi-exclamation-triangle-fill me-2"></i><strong>L∆∞u √Ω:</strong> H√£y ƒë·∫£m b·∫£o b·∫°n g·ª≠i ch√≠nh x√°c s·ªë SOK tr√™n. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ph√°t hi·ªán giao d·ªãch v√† k√≠ch ho·∫°t l·ªánh c·ªßa b·∫°n sau v√†i ph√∫t.</div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">T√¥i ƒë√£ hi·ªÉu</button></div></div></div></div>

    <!-- AI Chat Elements -->
    <div id="ai-chat-bubble"><i class="bi bi-robot"></i></div>
    <div id="ai-chat-window"><div class="chat-header"><strong>Tr·ª£ l√Ω AI Sokchain</strong><button type="button" class="btn-close btn-close-white" id="ai-chat-close-btn"></button></div><div class="chat-body" id="ai-chat-body"><div class="chat-message ai-message">Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n v·ªÅ h·ªá sinh th√°i Sokchain?</div></div><div class="chat-footer"><form id="ai-chat-form"><div class="input-group"><input type="text" id="ai-chat-input" class="form-control" placeholder="ƒê·∫∑t c√¢u h·ªèi..." autocomplete="off"><button class="btn btn-primary" type="submit"><i class="bi bi-send-fill"></i></button></div></form></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/elliptic@6.5.4/dist/elliptic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>
    <script src="/static/transaction.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & CONFIG ---
        let state = { userWallet: null, unlockedPrivateKey: null, treasuryInfo: null, initialBalance: 0 };
        const backupModalEl = document.getElementById('backupModal');
        const backupModal = new bootstrap.Modal(backupModalEl);
        const p2pDepositModal = new bootstrap.Modal(document.getElementById('p2pDepositModal'));
        const appToast = new bootstrap.Toast(document.getElementById('appToast'));

        // --- API HELPER ---
        const api = {
            async request(endpoint, method = 'GET', body = null) {
                try {
                    const options = { method, headers: { 'Content-Type': 'application/json' } };
                    if (body) options.body = JSON.stringify(body);
                    const response = await fetch(endpoint, options);
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server (${response.status})`);
                    }
                    return data;
                } catch (error) {
                    showToast(`L·ªói: ${error.message}`, 'L·ªói API');
                    throw error;
                }
            }
        };

        // --- UTILITY & RENDERING FUNCTIONS ---
        function showToast(message, title = 'Th√¥ng b√°o') {
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-body').innerText = message;
            appToast.show();
        }

        async function copyToClipboard(text) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                    showToast("ƒê√£ sao ch√©p v√†o clipboard!", "Th√†nh c√¥ng");
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast("ƒê√£ sao ch√©p v√†o clipboard!", "Th√†nh c√¥ng");
                }
            } catch (err) {
                console.error("L·ªói khi sao ch√©p:", err);
                showToast("Kh√¥ng th·ªÉ sao ch√©p t·ª± ƒë·ªông.", "L·ªói");
            }
        }

        function createWorkerItem(worker) {
            const isOnline = (Date.now() / 1000 - worker.last_seen) < 180;
            const statusClass = isOnline ? 'status-online' : 'status-offline';
            const statusText = isOnline ? 'Tr·ª±c tuy·∫øn' : 'Offline';
            return `<li class="worker-item"><div class="worker-info d-flex flex-column"><span class="worker-address" title="${worker.address}">${worker.address}</span><small><span class="status-indicator ${statusClass}"></span>${statusText}</small></div><button class="btn btn-sm" data-action="copy-address" data-address="${worker.address}"><i class="bi bi-clipboard-plus"></i></button></li>`;
        }
        
        // [START] B·ªï sung h√†m renderHistory
        async function renderHistory() {
            const container = document.getElementById('history-list-container');
            const refreshBtn = document.querySelector('button[data-action="refresh-history"]');

            if (!state.userWallet) {
                refreshBtn.disabled = true;
                container.innerHTML = `<p class="text-center text-muted p-5"><i class="bi bi-unlock-fill fs-1"></i><br>Vui l√≤ng m·ªü kh√≥a v√≠ ƒë·ªÉ xem l·ªãch s·ª≠ giao d·ªãch.</p>`;
                return;
            }

            refreshBtn.disabled = false;
            container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">ƒêang t·∫£i l·ªãch s·ª≠...</p></div>`;

            try {
                const history = await api.request(`/api/v1/transaction_history/${state.userWallet.address}`);
                if (!history.length) {
                    container.innerHTML = `<p class="text-center text-muted p-5"><i class="bi bi-emoji-frown fs-1"></i><br>Ch∆∞a c√≥ giao d·ªãch n√†o ƒë∆∞·ª£c ghi nh·∫≠n.</p>`;
                    return;
                }

                history.sort((a, b) => b.timestamp - a.timestamp);

                let html = '<div class="list-group">';
                history.forEach(tx => {
                    const txTime = new Date(tx.timestamp * 1000).toLocaleString('vi-VN');
                    let iconHtml = '';
                    let titleHtml = '';
                    let detailsHtml = '';
                    const amountStr = `${parseFloat(tx.amount).toFixed(8)} SOK`;

                    if (tx.from === "0") {
                        iconHtml = `<i class="bi bi-star-fill text-warning fs-4"></i>`;
                        titleHtml = `<strong>+ ${amountStr}</strong> - Ph·∫ßn th∆∞·ªüng M·∫°ng l∆∞·ªõi`;
                        detailsHtml = `V√†o v√≠ c·ªßa b·∫°n l√∫c ${txTime}`;
                    } else if (tx.type === 'sent' && state.treasuryInfo && tx.to === state.treasuryInfo.treasury_address) {
                        iconHtml = `<i class="bi bi-box-arrow-in-up text-info fs-4"></i>`;
                        titleHtml = `<strong>- ${amountStr}</strong> - N·∫°p ti·ªÅn cho Website`;
                        detailsHtml = `T·ª´ v√≠ c·ªßa b·∫°n l√∫c ${txTime}`;
                    } else if (tx.type === 'sent') {
                        iconHtml = `<i class="bi bi-arrow-down-circle-fill text-danger fs-4"></i>`;
                        titleHtml = `<strong>- ${amountStr}</strong> - G·ª≠i ƒëi`;
                        detailsHtml = `ƒê·∫øn v√≠: <code class="small">${tx.to.substring(0, 20)}...</code> l√∫c ${txTime}`;
                    } else {
                        iconHtml = `<i class="bi bi-arrow-up-circle-fill text-success fs-4"></i>`;
                        titleHtml = `<strong>+ ${amountStr}</strong> - Nh·∫≠n v√†o`;
                        detailsHtml = `T·ª´ v√≠: <code class="small">${tx.from.substring(0, 20)}...</code> l√∫c ${txTime}`;
                    }

                    html += `
                        <div class="list-group-item list-group-item-action d-flex gap-3 py-3">
                            <div class="flex-shrink-0">${iconHtml}</div>
                            <div class="d-flex gap-2 w-100 justify-content-between">
                                <div>
                                    <h6 class="mb-0">${titleHtml}</h6>
                                    <p class="mb-0 opacity-75 small">${detailsHtml}</p>
                                </div>
                                <small class="opacity-50 text-nowrap"><i class="bi bi-hash"></i>${tx.tx_hash.substring(0, 8)}</small>
                            </div>
                        </div>`;
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = `<p class="text-center text-danger p-5"><i class="bi bi-exclamation-triangle-fill fs-1"></i><br>L·ªói khi t·∫£i l·ªãch s·ª≠ giao d·ªãch.</p>`;
            }
        }
        // [END] B·ªï sung h√†m renderHistory
        
        function renderAll() {
            renderWallet();
            renderDashboard();
            renderManage();
            renderP2P();
            renderHistory(); // <-- [B·ªï sung] G·ªçi h√†m renderHistory
            renderExplorer();
            renderMining();
        }

        function renderWallet() {
            const walletContainers = document.querySelectorAll('.wallet-card[id$="-wallet-container"]');
            let htmlContent = '';
            if (state.userWallet) {
                htmlContent = `
                    <h5 class="text-success"><i class="bi bi-wallet-fill"></i> V√≠ ƒë√£ M·ªü kh√≥a</h5>
                    <div class="mb-2"><small>ƒê·ªãa ch·ªâ:</small><p class="wallet-info">${state.userWallet.address}</p></div>
                    <div class="mb-3 balance-container"><small>S·ªë d∆∞:</small><p class="wallet-info">truy v·∫•n SOK bot</p></div>
                    <button class="btn btn-sm btn-outline-danger w-100" data-action="logout"><i class="bi bi-lock-fill"></i> Kh√≥a V√≠</button>`;
                updateAllBalances();
            } else {
                htmlContent = `
                    <h5><i class="bi bi-unlock-fill"></i> M·ªü kh√≥a V√≠</h5><p class="small text-muted">D√πng v√≠ ƒë·ªÉ t∆∞∆°ng t√°c.</p>
                    <button class="btn btn-sm btn-success w-100 mb-2" data-action="create-wallet"><i class="bi bi-plus-lg"></i> T·∫°o V√≠ M·ªõi</button>
                    <div class="mb-2"><label class="form-label small">Ho·∫∑c d√°n Private Key:</label><textarea class="form-control form-control-sm import-pk-pem" rows="4"></textarea></div>
                    <button class="btn btn-sm btn-primary w-100" data-action="import-wallet"><i class="bi bi-key-fill"></i> M·ªü kh√≥a</button>`;
            }
            walletContainers.forEach(container => container.innerHTML = htmlContent);
        }

        async function renderDashboard() {
            try {
                const stats = await api.request('/api/v1/dashboard_stats');
                document.getElementById('active-workers').innerText = stats.active_workers;
                document.getElementById('total-websites').innerText = stats.total_websites;
                document.getElementById('views-completed').innerText = stats.views_completed_session;
                document.getElementById('blockchain-height').innerText = stats.blockchain_height > 0 ? stats.blockchain_height : 'N/A';
                document.getElementById('p2p-orders').innerText = stats.open_p2p_orders;
                
                const workers = await api.request('/api/v1/workers/list_by_type');
                const blList = document.getElementById('backlink-worker-list');
                const vwList = document.getElementById('view-worker-list');
                blList.innerHTML = workers.backlink_service.length > 0 ? workers.backlink_service.map(createWorkerItem).join('') : '<li class="text-muted text-center list-group-item">Kh√¥ng c√≥ worker n√†o.</li>';
                vwList.innerHTML = workers.view_worker.length > 0 ? workers.view_worker.map(createWorkerItem).join('') : '<li class="text-muted text-center list-group-item">Kh√¥ng c√≥ worker n√†o.</li>';
            } catch (e) { /* Ignore render errors */ }
        }

        async function renderManage() {
            const urlInput = document.getElementById('new-website-url');
            const addBtn = document.getElementById('add-btn');
            const fundingContainer = document.getElementById('funding-container');
            const websiteList = document.getElementById('website-list');
            if (state.userWallet) {
                urlInput.disabled = false;
                addBtn.disabled = false;
                if (state.treasuryInfo) {
                    fundingContainer.innerHTML = `
                        <h5><i class="bi bi-box-seam-fill"></i> N·∫°p SOK</h5>
                        <div class="mb-2"><label class="form-label small">ƒê·ªãa ch·ªâ Kho b·∫°c:</label><div class="wallet-info">${state.treasuryInfo.treasury_address.substring(0,25)}...</div></div>
                        <div class="mb-2"><label class="form-label small">S·ªë SOK n·∫°p:</label><input type="number" id="funding-amount" class="form-control form-control-sm" placeholder="T·ªëi thi·ªÉu ${state.treasuryInfo.minimum_funding}"></div>
                        <button class="btn btn-sm btn-warning w-100" data-action="fund"><i class="bi bi-send-check-fill"></i> N·∫°p ti·ªÅn</button>`;
                    fundingContainer.style.display = 'block';
                }
                const sites = await api.request(`/api/v1/websites/list?owner=${state.userWallet.address}`);
                websiteList.innerHTML = sites.length ? '' : '<li class="text-center text-muted">B·∫°n ch∆∞a th√™m website n√†o.</li>';
                sites.forEach(site => {
                    const status = site.info.views_funded > 0 ? `<span class="text-success"><i class="bi bi-check-circle-fill"></i> C√≤n ${site.info.views_funded} l∆∞·ª£t</span>` : '<span class="text-warning"><i class="bi bi-hourglass-split"></i> Ch·ªù n·∫°p</span>';
                    websiteList.innerHTML += `<li><span class="fw-bold">${site.url}</span><span>${status} | Xong: ${site.info.views_completed}</span><button class="btn btn-sm btn-danger" data-action="remove-website" data-url="${site.url}"><i class="bi bi-trash-fill"></i></button></li>`;
                });
            } else {
                urlInput.disabled = true;
                addBtn.disabled = true;
                fundingContainer.style.display = 'none';
                websiteList.innerHTML = '<li class="text-center text-muted">M·ªü kh√≥a V√≠ ƒë·ªÉ qu·∫£n l√Ω.</li>';
            }
        }
        
        async function renderP2P() {
            document.querySelector('button[data-action="create-sell-order"]').disabled = !state.userWallet;
            const tableBody = document.getElementById('open-orders-table');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">ƒêang t·∫£i...</td></tr>';
            try {
                const orders = await api.request('/api/v1/p2p/orders/list');
                tableBody.innerHTML = '';
                if (!orders.length) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Ch∆∞a c√≥ l·ªánh b√°n n√†o.</td></tr>';
                }
                orders.forEach(order => {
                    tableBody.innerHTML += `<tr><td>${order.seller_address.substring(0,12)}...</td><td>${order.sok_amount}</td><td>${order.fiat_details}</td><td><button class="btn btn-sm btn-success" data-action="accept-p2p-order" data-order-id="${order.id}" ${state.userWallet ? '' : 'disabled'}>Mua</button></td></tr>`;
                });
            } catch (e) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">L·ªói t·∫£i d·ªØ li·ªáu.</td></tr>';
            }
        }
        
        async function updateAllBalances() {
            if (!state.userWallet) return;
            const balanceContainers = document.querySelectorAll('.balance-container p');
            try {
                const data = await api.request(`/api/get_balance/${state.userWallet.address}`);
                const balanceValue = parseFloat(data.balance);
                balanceContainers.forEach(p => {
                    p.className = 'wallet-info';
                    p.textContent = `${balanceValue.toFixed(8)} SOK`;
                    p.classList.add(balanceValue > 0 ? 'text-success' : 'text-muted', 'fw-bold');
                });
            } catch (e) {
                balanceContainers.forEach(p => { p.textContent = 'L·ªói t·∫£i s·ªë d∆∞'; p.classList.add('text-danger'); });
            }
        }

        async function renderExplorer() {
            const container = document.getElementById('explorer-content');
            container.innerHTML = `<p class="text-center text-muted">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ blockchain...</p>`;
            try {
                const data = await api.request('/api/v1/explorer_data');
                if (!data.chain || data.chain.length === 0) {
                    container.innerHTML = `<p class="text-center text-warning">Kh√¥ng c√≥ kh·ªëi n√†o ƒë·ªÉ hi·ªÉn th·ªã.</p>`;
                    return;
                }
                let html = '';
                [...data.chain].reverse().forEach(block => {
                    const blockTime = new Date(block.timestamp * 1000).toLocaleString('vi-VN');
                    let txHtml = block.transactions?.length > 0 ?
                        block.transactions.map(tx => `<div class="tx-item">${tx.sender_address === "0" ? `<span class="badge bg-success">Th∆∞·ªüng</span>` : `<span class="badge bg-primary">Chuy·ªÉn</span>`} <strong>${parseFloat(tx.amount).toFixed(4)} SOK</strong><div class="text-muted small">ƒê·∫øn: ${tx.recipient_address.substring(0, 20)}...</div></div>`).join('') :
                        '<div class="text-muted small p-2">Kh√¥ng c√≥ giao d·ªãch.</div>';
                    html += `<div class="block-card"><div class="block-header">Kh·ªëi #${block.index} <small class="float-end text-muted">${blockTime}</small></div><div class="block-details"><div class="text-truncate"><strong>Hash:</strong> <span class="text-info">${block.hash}</span></div><div>${txHtml}</div></div></div>`;
                });
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<p class="text-center text-danger">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${e.message}</p>`;
            }
        }

        async function renderMining() {
            const statusIcon = document.getElementById('miner-status-icon');
            const statusText = document.getElementById('miner-status-text');
            const controlBtn = document.getElementById('miner-control-btn');
            try {
                const data = await api.request('/api/v1/miner/status');
                controlBtn.disabled = false;
                controlBtn.innerHTML = '';
                if (data.status === 'running') {
                    statusIcon.innerHTML = '<i class="bi bi-cpu-fill text-success" style="font-size: 4rem; animation: pulse 2s infinite;"></i>';
                    statusText.innerHTML = `ƒêang ho·∫°t ƒë·ªông. ${data.pid ? `(PID: ${data.pid})` : ''}`;
                    controlBtn.innerHTML = '<i class="bi bi-stop-circle-fill me-2"></i>D·ª´ng Khai th√°c';
                    controlBtn.className = 'btn btn-lg w-100 btn-danger';
                    controlBtn.dataset.nextState = 'stop';
                } else {
                    statusIcon.innerHTML = '<i class="bi bi-power text-danger" style="font-size: 4rem;"></i>';
                    statusText.textContent = 'ƒê√£ d·ª´ng.';
                    controlBtn.innerHTML = '<i class="bi bi-play-circle-fill me-2"></i>B·∫Øt ƒë·∫ßu Khai th√°c';
                    controlBtn.className = 'btn btn-lg w-100 btn-success';
                    controlBtn.dataset.nextState = 'start';
                }
            } catch (error) {
                statusIcon.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 4rem;"></i>';
                statusText.textContent = 'L·ªói khi ki·ªÉm tra tr·∫°ng th√°i.';
                controlBtn.disabled = true;
                controlBtn.textContent = 'Th·ª≠ l·∫°i sau';
            }
        }

        function pollForBalanceUpdate(maxAttempts = 10, interval = 3000) {
            let attempts = 0;
            const poller = setInterval(async () => {
                attempts++;
                if (attempts > maxAttempts) {
                    clearInterval(poller);
                    showToast("Giao d·ªãch ƒë√£ g·ª≠i nh∆∞ng s·ªë d∆∞ ch∆∞a c·∫≠p nh·∫≠t.", "C·∫£nh b√°o");
                    return;
                }
                try {
                    const data = await api.request(`/api/get_balance/${state.userWallet.address}`);
                    const newBalance = parseFloat(data.balance);
                    if (newBalance !== state.initialBalance) {
                        clearInterval(poller);
                        showToast("S·ªë d∆∞ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!", "Th√†nh c√¥ng");
                        renderAll();
                    }
                } catch (e) { /* Ignore poll errors */ }
            }, interval);
        }

        async function handleTransaction() {
            try {
                const data = await api.request(`/api/get_balance/${state.userWallet.address}`);
                state.initialBalance = parseFloat(data.balance);
            } catch (e) {
                state.initialBalance = 0;
            }
            showToast("Giao d·ªãch ƒë√£ ƒë∆∞·ª£c g·ª≠i! ƒêang ch·ªù x√°c nh·∫≠n...", "Th√¥ng tin");
            pollForBalanceUpdate();
        }

        function triggerSokWiggle() {
            const sokText = document.getElementById('sok-brand-text');
            if (sokText) {
                sokText.classList.add('animate-wiggle');
                setTimeout(() => sokText.classList.remove('animate-wiggle'), 500);
            }
        }

        // --- EVENT HANDLING ---
        document.body.addEventListener('click', async (event) => {
            const button = event.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const handleSuccessLogin = (walletData, pkPem) => {
                state.userWallet = { address: walletData.address, public_key_pem: walletData.public_key_pem };
                state.unlockedPrivateKey = pkPem;
                renderAll();
                showToast("V√≠ ƒë√£ ƒë∆∞·ª£c m·ªü kh√≥a th√†nh c√¥ng!", "Th√†nh c√¥ng");
                aiAgent.triggerWelcome();
            };

            switch (action) {
                case 'create-wallet': {
                    const data = await api.request('/api/create_wallet', 'POST');
                    if(data){
                        backupModalEl.dataset.walletInfo = JSON.stringify(data);
                        document.getElementById('modal-private-key').value = data.private_key_pem;
                        backupModal.show();
                    }
                    break;
                }
                case 'copy-and-close-modal': {
                    const pkTextarea = document.getElementById('modal-private-key');
                    await copyToClipboard(pkTextarea.value);
                    
                    document.getElementById('modal-copied-message').style.display = 'inline';
                    setTimeout(() => {
                        const walletData = JSON.parse(backupModalEl.dataset.walletInfo || '{}');
                        handleSuccessLogin(walletData, walletData.private_key_pem);
                        backupModal.hide();
                    }, 1500);
                    break;
                }
                case 'import-wallet': {
                    const pkPem = button.parentElement.querySelector('.import-pk-pem').value.trim();
                    if (!pkPem) return showToast("Vui l√≤ng nh·∫≠p Private Key.", "C·∫£nh b√°o");
                    const walletData = await api.request('/api/wallet_from_pk', 'POST', { private_key_pem: pkPem });
                    if (walletData) handleSuccessLogin(walletData, pkPem);
                    break;
                }
                case 'logout': {
                    aiAgent.addMessage("B·∫°n ƒë√£ kh√≥a v√≠. T√¥i s·∫Ω kh√¥ng th·ªÉ truy c·∫≠p th√¥ng tin t√†i kho·∫£n c·ªßa b·∫°n n·ªØa.", 'ai');
                    state = { ...state, userWallet: null, unlockedPrivateKey: null };
                    renderAll();
                    break;
                }
                case 'copy-address': {
                    await copyToClipboard(button.dataset.address);
                    break;
                }
                case 'add-website': {
                    const newUrl = document.getElementById('new-website-url').value.trim();
                    if (!newUrl) return showToast('Vui l√≤ng nh·∫≠p URL.', 'C·∫£nh b√°o');
                    await api.request('/api/v1/websites/add', 'POST', { url: newUrl, owner_pk_pem: state.userWallet.public_key_pem });
                    showToast('Th√™m website th√†nh c√¥ng!', 'Th√†nh c√¥ng');
                    document.getElementById('new-website-url').value = '';
                    renderManage();
                    break;
                }
                case 'remove-website': {
                    if (confirm(`X√≥a website: ${button.dataset.url}?`)) {
                        await api.request('/api/v1/websites/remove', 'POST', { url: button.dataset.url, owner_address: state.userWallet.address });
                        showToast('ƒê√£ x√≥a website.', 'Th√†nh c√¥ng');
                        renderManage();
                    }
                    break;
                }
                case 'fund': {
                    const fundAmount = document.getElementById('funding-amount').value.trim();
                    if (!fundAmount || parseFloat(fundAmount) <= 0) return showToast("Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá.", "C·∫£nh b√°o");
                    await api.request('/api/direct_fund', 'POST', { private_key_pem: state.unlockedPrivateKey, recipient_address: state.treasuryInfo.treasury_address, amount: fundAmount });
                    handleTransaction();
                    break;
                }
                case 'create-sell-order': {
                    const sokAmount = document.getElementById('sokAmount').value.trim();
                    const fiatDetails = document.getElementById('fiatDetails').value.trim();
                    if (!sokAmount || !fiatDetails || parseFloat(sokAmount) <= 0) return showToast("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin v√† s·ªë SOK h·ª£p l·ªá.", "C·∫£nh b√°o");
                    const data = await api.request('/api/v1/p2p/orders/create', 'POST', { seller_address: state.userWallet.address, sok_amount: sokAmount, fiat_details: fiatDetails });
                    if (data) {
                        document.getElementById('p2p-modal-amount').textContent = `${sokAmount} SOK`;
                        document.getElementById('p2p-modal-address').value = data.escrow_address;
                        p2pDepositModal.show();
                        document.getElementById('sokAmount').value = '';
                        document.getElementById('fiatDetails').value = '';
                    }
                    break;
                }
                case 'copy-p2p-address': {
                    const addressInput = document.getElementById('p2p-modal-address');
                    await copyToClipboard(addressInput.value);
                    const icon = button.querySelector('i');
                    icon.className = 'bi bi-clipboard-check-fill';
                    setTimeout(() => icon.className = 'bi bi-clipboard-plus', 2000);
                    break;
                }
                case 'accept-p2p-order': {
                    if (!state.userWallet) return showToast("Vui l√≤ng m·ªü kh√≥a v√≠ ƒë·ªÉ mua.", "Y√™u c·∫ßu");
                    if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën mua SOK t·ª´ l·ªánh n√†y kh√¥ng?")) return;
                    const result = await api.request(`/api/v1/p2p/orders/${button.dataset.orderId}/accept`, 'POST', { buyer_address: state.userWallet.address });
                    if (result) {
                        alert(`${result.message}\n\nVui l√≤ng chuy·ªÉn kho·∫£n ƒë·∫øn ng∆∞·ªùi b√°n v√† ch·ªù h·ªç x√°c nh·∫≠n ƒë·ªÉ nh·∫≠n SOK.`);
                        renderP2P();
                    }
                    break;
                }
                case 'refresh-p2p-orders':
                    renderP2P();
                    break;
                
                case 'refresh-explorer': {
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>ƒêang t·∫£i...';
                    showToast("ƒêang l√†m m·ªõi d·ªØ li·ªáu chu·ªói...");
                    try {
                        await renderExplorer();
                    } finally {
                        setTimeout(() => {
                            button.disabled = false;
                            button.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>L√†m m·ªõi';
                        }, 5000); // Cooldown 5 gi√¢y
                    }
                    break;
                }
                
                // [START] B·ªï sung s·ª± ki·ªán cho n√∫t l√†m m·ªõi History
                case 'refresh-history': {
                    button.disabled = true;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>ƒêang t·∫£i...';
                    await renderHistory();
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>L√†m m·ªõi L·ªãch s·ª≠';
                    }, 1000);
                    break;
                }
                // [END] B·ªï sung s·ª± ki·ªán cho n√∫t l√†m m·ªõi History
                
                case 'toggle-miner': {
                    const nextState = button.dataset.nextState;
                    button.disabled = true;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ƒêang x·ª≠ l√Ω...';
                    try {
                        const result = await api.request(`/api/v1/miner/${nextState}`, 'POST');
                        showToast(result.message, 'Th√†nh c√¥ng');
                    } catch (error) { /* Handled by API helper */ }
                    finally {
                        setTimeout(renderMining, 1000);
                    }
                    break;
                }
            }
        });

        // [START] B·ªï sung s·ª± ki·ªán khi chuy·ªÉn tab History
        const historyTab = document.querySelector('button[data-bs-target="#history-pane"]');
        if (historyTab) {
            historyTab.addEventListener('shown.bs.tab', event => {
                renderHistory();
            });
        }
        // [END] B·ªï sung s·ª± ki·ªán khi chuy·ªÉn tab History

        // --- AI CHAT AGENT ---
        const aiAgent = {
            bubble: document.getElementById('ai-chat-bubble'),
            window: document.getElementById('ai-chat-window'),
            body: document.getElementById('ai-chat-body'),
            form: document.getElementById('ai-chat-form'),
            input: document.getElementById('ai-chat-input'),
            init() {
                this.bubble.addEventListener('click', () => this.toggle());
                document.getElementById('ai-chat-close-btn').addEventListener('click', () => this.hide());
                this.form.addEventListener('submit', (e) => this.handleUserInput(e));
            },
            toggle() {
                this.window.classList.toggle('show');
                if (this.window.classList.contains('show')) this.input.focus();
            },
            hide() { this.window.classList.remove('show'); },
            addMessage(message, sender) {
                const div = document.createElement('div');
                div.className = `chat-message ${sender}-message`;
                div.textContent = message;
                this.body.appendChild(div);
                this.body.scrollTop = this.body.scrollHeight;
                if (sender === 'ai') triggerSokWiggle();
            },
            showTyping() {
                const i = document.createElement('div');
                i.id = 'ai-typing-indicator';
                i.className = 'chat-message ai-message';
                i.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                this.body.appendChild(i);
                this.body.scrollTop = this.body.scrollHeight;
                triggerSokWiggle();
            },
            hideTyping() { document.getElementById('ai-typing-indicator')?.remove(); },
            async handleUserInput(e) {
                e.preventDefault();
                const userInput = this.input.value.trim();
                if (!userInput) return;
                this.addMessage(userInput, 'user');
                this.input.value = '';
                this.showTyping();
                try {
                    const response = await api.request('/api/v1/ai/chat', 'POST', { query: userInput, address: state.userWallet ? state.userWallet.address : null });
                    this.hideTyping();
                    this.addMessage(response.reply, 'ai');
                } catch (error) {
                    this.hideTyping();
                    this.addMessage("Xin l·ªói, t√¥i g·∫∑p s·ª± c·ªë khi k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.", 'ai');
                }
            },
            triggerWelcome() {
                if (!this.window.classList.contains('show')) this.toggle();
                this.showTyping();
                setTimeout(async () => {
                    try {
                        const response = await api.request('/api/v1/ai/chat', 'POST', { query: "Ch√†o b·∫°n, h√£y t√≥m t·∫Øt t√†i kho·∫£n c·ªßa t√¥i.", address: state.userWallet.address });
                        this.hideTyping();
                        this.addMessage(response.reply, 'ai');
                    } catch (error) {
                        this.hideTyping();
                        this.addMessage("Ch√†o m·ª´ng b·∫°n quay tr·ªü l·∫°i!", 'ai');
                    }
                }, 500);
            }
        };

        // --- INITIALIZATION ---
        async function initialize() {
            renderAll();
            aiAgent.init();
            
            function randomWiggleLoop() {
                const randomDelay = Math.random() * 13000 + 7000;
                setTimeout(() => {
                    triggerSokWiggle();
                    randomWiggleLoop();
                }, randomDelay);
            }
            randomWiggleLoop();

            setInterval(renderDashboard, 20000);
            setInterval(renderMining, 30000);

            try {
                state.treasuryInfo = await api.request('/api/v1/payment_info');
            } catch (e) {
                showToast("L·ªói nghi√™m tr·ªçng khi t·∫£i c·∫•u h√¨nh ban ƒë·∫ßu.", "L·ªói h·ªá th·ªëng");
            }
        }
        
        initialize();
    });
    </script>
</body>
</html>