<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ΣOK Chain - Bảng Điều Khiển Hợp Nhất</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary-accent: #6f42c1;
            --primary-accent-hover: #5a37a0; 
            --border-color: rgba(255, 255, 255, 0.2); 
            --border-radius-main: 16px;
            --box-shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.1);
            --neon-glow-color: #a052c8;
        }

        @keyframes aurora-background {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes neon-ripple-glow {
            0% { box-shadow: 0 0 5px var(--neon-glow-color), 0 0 10px var(--neon-glow-color), 0 0 15px var(--primary-accent); }
            50% { box-shadow: 0 0 10px var(--primary-accent), 0 0 20px var(--neon-glow-color), 0 0 30px var(--primary-accent); }
            100% { box-shadow: 0 0 5px var(--neon-glow-color), 0 0 10px var(--neon-glow-color), 0 0 15px var(--primary-accent); }
        }

        @keyframes sok-wiggle {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(4deg) translateY(-2px); }
            50% { transform: rotate(-4deg); }
            75% { transform: rotate(2deg) translateY(-1px); }
            100% { transform: rotate(0deg); }
        }
        
        @keyframes move-soul {
            0% { transform: translate(10vw, 10vh) scale(1); opacity: 0.7; }
            15% { transform: translate(40vw, 60vh) scale(1.2); opacity: 0.4; }
            30% { transform: translate(80vw, 80vh) scale(0.9); opacity: 0.8; }
            45% { transform: translate(90vw, 20vh) scale(1.1); opacity: 0.5; }
            60% { transform: translate(50vw, 5vh) scale(1); opacity: 0.9; }
            75% { transform: translate(20vw, 90vh) scale(1.3); opacity: 0.6; }
            90% { transform: translate(5vw, 50vh) scale(1); opacity: 0.8; }
            100% { transform: translate(10vw, 10vh) scale(1); opacity: 0.7; }
        }

        #soul-particle {
            position: fixed;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(160, 82, 200, 0.6) 40%, rgba(111, 66, 193, 0.3) 100%);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(160, 82, 200, 0.8), 0 0 25px rgba(255, 255, 255, 0.5) inset;
            z-index: 999;
            pointer-events: none; /* Quan trọng: để không chặn các click chuột */
            animation: move-soul 45s linear infinite;
            will-change: transform, opacity; /* Gợi ý cho trình duyệt để tối ưu hiệu năng */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #0b1a2b, #1d2c67, #3b4a8a, #4a8da8, #2ca58d, #8a4a7c, #4a2c5a);
            background-size: 400% 400%;
            animation: aurora-background 18s ease infinite;
            color: #333;
        }
        
        #sok-brand-text {
            display: inline-block;
        }
        #sok-brand-text.animate-wiggle {
            animation: sok-wiggle 0.5s ease-in-out;
        }

        .navbar, .tab-content, .wallet-card, .card, .main-content-card, .mining-card {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); 
            border: 1px solid var(--border-color);
        }

        .navbar { 
            box-shadow: 0 2px 10px rgba(0,0,0,.1); 
            background-color: rgba(255, 255, 255, 0.9);
        }

        .main-container { max-width: 1200px; margin: auto; }
        .nav-tabs { border-bottom: none; }
        .nav-tabs .nav-link { 
            font-weight: 500; 
            color: var(--primary-accent); 
            border: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0 !important;
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-accent);
            border-color: var(--primary-accent);
            background-color: rgba(255, 255, 255, 0.95) !important;
            box-shadow: 0 -4px 15px rgba(111, 66, 193, 0.2);
            transform: translateY(-2px);
        }
        
        .tab-content { padding: 2rem; border-top: none; border-radius: 0 0 var(--border-radius-main) var(--border-radius-main); min-height: 70vh; }
        .page-header { text-align: center; margin-bottom: 2rem; }
        .page-header h1 { font-weight: 700; color: #111; }
        .page-header .lead { color: #555 !important; }

        .wallet-card { border-radius: var(--border-radius-main); box-shadow: var(--box-shadow-soft); padding: 2rem; }
        .wallet-info { 
            word-break: break-all; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; 
            background-color: #f0f2f5; 
            padding: 12px; border-radius: 10px; border: 1px solid #ddd;
        }
        .btn { border-radius: 12px; font-weight: 500; transition: all 0.2s ease-in-out; }
        
        .stat-card { 
            text-align: center; padding: 15px; background-color: rgba(248, 249, 250, 0.8); 
            border-radius: var(--border-radius-main); transition: transform 0.2s, box-shadow 0.3s ease;
            border: 1px solid transparent;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.25);
            border-color: rgba(111, 66, 193, 0.3);
        }
        
        .stat-icon { font-size: 2rem; color: var(--primary-accent); transition: color 0.3s ease; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: #222; }
        .stat-label { font-size: 0.8rem; text-transform: uppercase; color: #666; }
        
        .worker-list, #explorer-content { max-height: 500px; overflow-y: auto; }
        .worker-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background-color: rgba(240, 242, 245, 0.9); border-radius: 10px; margin-bottom: 8px; }
        .worker-address { font-family: 'Courier New', Courier, monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-online { background-color: #198754; animation: pulse 2s infinite; }
        .status-offline { background-color: #6c757d; }
        .status-busy { background-color: #ffc107; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(25,135,84,0.7); } 70% { box-shadow: 0 0 0 8px rgba(25,135,84,0); } 100% { box-shadow: 0 0 0 0 rgba(25,135,84,0); } }
        
        #website-list li { background-color: #f8f9fa; margin-bottom: 0.75rem; padding: 1rem 1.5rem; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .table-hover tbody tr:hover { background-color: rgba(248, 249, 250, 0.7); cursor: pointer; }
        
        .block-card { background: #ffffff; border: 1px solid #e0e6ed; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .block-header { padding: 10px 15px; border-bottom: 1px solid #e0e6ed; font-weight: bold; font-size: 1.1rem; color: #2980b9; }
        .block-details { padding: 15px; font-size: 0.8rem; }
        .tx-item { padding: 10px; border-top: 1px dashed #e0e6ed; }
        
        #ai-chat-bubble {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background-image: linear-gradient(45deg, var(--primary-accent), var(--neon-glow-color));
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: white; cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.3s ease; z-index: 1050;
            animation: neon-ripple-glow 4s infinite ease-in-out;
        }
        #ai-chat-bubble:hover { transform: scale(1.1); }
        
        #ai-chat-window { position: fixed; bottom: 100px; right: 25px; width: 350px; max-width: 90vw; height: 500px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: var(--border-radius-main); box-shadow: 0 5px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; transition: opacity 0.3s, transform 0.3s; transform: translateY(20px); opacity: 0; z-index: 1040; pointer-events: none; border: 1px solid rgba(255,255,255,0.2); }
        #ai-chat-window.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .chat-header { padding: 1rem; background: var(--primary-accent); color: white; border-radius: var(--border-radius-main) var(--border-radius-main) 0 0; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.5; white-space: pre-wrap; }
        .user-message { background-color: #e9ecef; color: #333; border-bottom-right-radius: 4px; align-self: flex-end; }
        .ai-message { background-color: var(--primary-accent); color: white; border-bottom-left-radius: 4px; align-self: flex-start; }
        .chat-footer { padding: 0.5rem 1rem; border-top: 1px solid var(--border-color); }
    </style>
</head>
<body>
    <div id="soul-particle"></div>
    <nav class="navbar navbar-expand-lg mb-4">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="/static/logo.png" alt="Sokchain Logo" style="height: 35px; margin-right: 10px;">
                <strong><span id="sok-brand-text">ΣOK</span></strong> Chain Web3 AI integration
            </a>
        </div>
    </nav>
    <div class="main-container container">
        <!-- [START] Bổ sung Tab History vào thanh điều hướng -->
        <ul class="nav nav-tabs" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboard-pane" type="button" role="tab"><i class="bi bi-speedometer2 me-1"></i>Cpanel</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#guide-pane" type="button" role="tab"><i class="bi bi-book-half me-1"></i>Hướng dẫn</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#manage-pane" type="button" role="tab"><i class="bi bi-globe-americas me-1"></i>Quản lý Website</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#market-pane" type="button" role="tab"><i class="bi bi-cart3 me-1"></i>Chợ P2P</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab"><i class="bi bi-clock-history me-1"></i>Lịch sử GD</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#explorer-pane" type="button" role="tab"><i class="bi bi-search me-1"></i>Explorer</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#mining-pane" type="button" role="tab"><i class="bi bi-pickaxe me-1"></i>Khai thác</button></li>
        </ul>
        <!-- [END] Bổ sung Tab History vào thanh điều hướng -->

        <div class="tab-content" id="myTabContent">
            <!-- Cpanel Tab -->
            <div class="tab-pane fade show active" id="dashboard-pane" role="tabpanel">
                <div class="page-header"><h1>Cpanel</h1><p class="lead text-muted">Theo dõi sức khỏe và các hoạt động chính của toàn bộ hệ sinh thái SOK.</p></div>
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg-2"><div class="stat-card"><div class="stat-icon"><i class="bi bi-people-fill"></i></div><div id="active-workers" class="stat-value">...</div><div class="stat-label">Worker Online</div></div></div>
                    <div class="col-6 col-md-4 col-lg-2"><div class="stat-card"><div class="stat-icon"><i class="bi bi-globe2"></i></div><div id="total-websites" class="stat-value">...</div><div class="stat-label">Tổng Website</div></div></div>
                    <div class="col-6 col-md-4 col-lg-2"><div class="stat-card"><div class="stat-icon"><i class="bi bi-eye-fill"></i></div><div id="views-completed" class="stat-value">...</div><div class="stat-label">Lượt xem</div></div></div>
                    <div class="col-6 col-md-4 col-lg-2"><div class="stat-card"><div class="stat-icon"><i class="bi bi-bricks"></i></div><div id="blockchain-height" class="stat-value">...</div><div class="stat-label">Chiều cao Chain</div></div></div>
                    <div class="col-6 col-md-4 col-lg-2"><div class="stat-card"><div class="stat-icon"><i class="bi bi-arrow-left-right"></i></div><div id="p2p-orders" class="stat-value">...</div><div class="stat-label">Lệnh P2P</div></div></div>
                </div>
                <div class="row g-4"><div class="col-lg-6"><h5 class="mb-3"><i class="bi bi-link-45deg text-primary"></i> Dịch Vụ Backlink thanh toán bằng SOK</h5><ul id="backlink-worker-list" class="worker-list"><p class="text-center mt-3">Truy vấn SOK bot</p></ul></div><div class="col-lg-6"><h5 class="mb-3"><i class="bi bi-person-workspace text-info"></i> Thợ đào và Viewer</h5><ul id="view-worker-list" class="worker-list"><p class="text-center mt-3">Truy vấn SOK bot</p></ul></div></div>
            </div>
            
            <!-- Guide Tab -->
            <div class="tab-pane fade" id="guide-pane" role="tabpanel">
                <div class="page-header">
                    <h1><i class="bi bi-book-half"></i> Hướng dẫn sử dụng SOK Chain</h1>
                    <p class="lead text-muted">Chào mừng bạn đến với hệ sinh thái ΣOK Chain! Dưới đây là các bước để bắt đầu.</p>
                </div>
                <div class="accordion" id="guide-accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                <strong>Bước 1: Tạo hoặc Mở khóa Ví SOK</strong>
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#guide-accordion">
                            <div class="accordion-body">
                                <p>Ví SOK là cửa ngõ để bạn tương tác với mọi tính năng của hệ thống. Bạn có thể tìm thấy khu vực quản lý ví ở bất kỳ tab chức năng nào như "Quản lý Website", "Chợ P2P", hoặc "Staking".</p>
                                <ul>
                                    <li><strong>Tạo Ví Mới:</strong> Nhấn nút "Tạo Ví Mới". Một cửa sổ cảnh báo sẽ hiện ra, chứa <strong>KHÓA BÍ MẬT (Private Key)</strong> của bạn.</li>
                                    <li><strong><span class="text-danger">QUAN TRỌNG:</span></strong> Hãy sao chép và lưu trữ Khóa Bí Mật này ở một nơi CỰC KỲ an toàn (ví dụ: trình quản lý mật khẩu, ghi ra giấy cất đi). Nếu làm mất khóa này, bạn sẽ mất quyền truy cập vào ví và toàn bộ tài sản trong đó vĩnh viễn.</li>
                                    <li><strong>Mở khóa Ví:</strong> Nếu đã có Khóa Bí Mật, hãy dán nó vào ô "Hoặc dán Private Key" và nhấn "Mở khóa".</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                <strong>Bước 2: Có SOK trong ví</strong>
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#guide-accordion">
                            <div class="accordion-body">
                                Có hai cách chính để sở hữu SOK:
                                <ol>
                                    <li><strong>Mua trên Chợ P2P:</strong> Vào tab "Chợ P2P", bạn sẽ thấy danh sách những người đang bán SOK. Chọn một lệnh bán phù hợp, nhấn "Mua", sau đó chuyển khoản theo thông tin người bán cung cấp để nhận SOK.</li>
                                    <li><strong>Khai thác (Mining):</strong> Vào tab "Khai thác" và làm theo hướng dẫn để tải về công cụ khai thác. Bằng cách đóng góp sức mạnh xử lý của máy tính, bạn sẽ nhận được phần thưởng là SOK.</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                <strong>Bước 3: Sử dụng và Kiếm thêm SOK</strong>
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#guide-accordion">
                            <div class="accordion-body">
                                <h5>Sử dụng SOK:</h5>
                                <p>Vào tab <strong>"Quản lý Website"</strong>. Tại đây, bạn có thể:</p>
                                <ul>
                                    <li>Thêm URL website của bạn vào hệ thống.</li>
                                    <li>Nạp SOK vào "Kho bạc" để bắt đầu các chiến dịch quảng cáo, tăng lượt xem cho website của mình.</li>
                                </ul>
                                <h5>Kiếm thêm SOK:</h5>
                                <ul>
                                    <li><strong>Bán trên Chợ P2P:</strong> Nếu bạn có SOK và muốn bán, hãy vào tab "Chợ P2P", tạo lệnh bán và cung cấp thông tin nhận tiền của bạn.</li>
                                    <li><strong>Khai thác:</strong> Như đã đề cập ở Bước 2, đây là cách tham gia trực tiếp vào việc bảo mật mạng lưới và nhận thưởng.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                     <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFour">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour">
                                <strong>Trợ lý AI và các tính năng khác</strong>
                            </button>
                        </h2>
                        <div id="collapseFour" class="accordion-collapse collapse" data-bs-parent="#guide-accordion">
                            <div class="accordion-body">
                                <ul>
                                    <li><strong>Trợ lý AI:</strong> Bong bóng chat ở góc dưới bên phải là Trợ lý AI của SOK Chain. Khi bạn đã mở khóa ví, nó có thể tóm tắt thông tin tài khoản, giải đáp thắc mắc và hướng dẫn bạn sử dụng các tính năng.</li>
                                    <li><strong>Explorer:</strong> Tab "Explorer" cho phép bạn xem các giao dịch và khối đang được tạo ra trên blockchain một cách minh bạch.</li>
                                </ul>
                                <div class="alert alert-info mt-3">
                                    <i class="bi bi-info-circle-fill"></i> <strong>Mẹo:</strong> Hãy luôn kiểm tra các thông báo nhỏ (toast) hiện lên ở góc màn hình sau mỗi hành động để biết trạng thái xử lý.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Website Tab -->
            <div class="tab-pane fade" id="manage-pane" role="tabpanel">
                <div class="page-header"><h1>🚀 Bệ phóng Quảng cáo</h1><p class="lead">Thêm trang web, nạp SOK và bắt đầu chiến dịch của bạn.</p></div>
                <div class="row"><div class="col-lg-8"><div class="main-content-card"><h3><i class="bi bi-globe-americas text-primary"></i> Website của bạn</h3><div class="mb-3"><input type="url" class="form-control" id="new-website-url" placeholder="https://your-website.com" disabled></div><button id="add-btn" class="btn btn-primary w-100" data-action="add-website" disabled><i class="bi bi-plus-circle-fill me-2"></i>Thêm Website Mới</button><hr class="my-4"><ul id="website-list" class="list-unstyled"><li class="text-center text-muted py-3">Hãy Mở khóa Ví để bắt đầu!</li></ul></div></div><div class="col-lg-4"><div class="wallet-card" id="manage-wallet-container"></div><div class="wallet-card mt-3" id="funding-container" style="display:none;"></div></div></div>
            </div>

            <!-- P2P Market Tab -->
            <div class="tab-pane fade" id="market-pane" role="tabpanel">
                <div class="page-header"><h1>🛒 Chợ Giao Dịch P2P SOK</h1><p class="lead">Nơi mua bán SOK an toàn và minh bạch giữa các thành viên.</p></div>
                <div class="wallet-card mb-4" id="p2p-wallet-container"></div>
                <div class="card mb-4"><div class="card-body"><h5 class="card-title">Tạo Lệnh Bán Mới</h5><div class="row g-3"><div class="col-md-4"><label class="form-label">Số lượng SOK bán</label><input type="number" class="form-control" id="sokAmount" placeholder="1000"></div><div class="col-md-8"><label class="form-label">Thông tin nhận tiền (VNĐ)</label><input type="text" class="form-control" id="fiatDetails" placeholder="VCB 0123456789 - NGUYEN VAN A - 250,000 VND"></div></div><button class="btn btn-success mt-3" data-action="create-sell-order" disabled><i class="bi bi-send-plus-fill"></i> Đăng bán</button></div></div>
                <div class="card"><div class="card-body"><h5 class="card-title">Các Lệnh Đang Mở Bán</h5><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>Người Bán</th><th>Số Lượng (SOK)</th><th>Thông Tin Thanh Toán</th><th>Hành Động</th></tr></thead><tbody id="open-orders-table"></tbody></table></div><div class="text-center mt-2"><button class="btn btn-sm btn-outline-primary" data-action="refresh-p2p-orders">Làm mới</button></div></div></div>
            </div>
            
            <!-- [START] Bổ sung nội dung Tab History -->
            <div class="tab-pane fade" id="history-pane" role="tabpanel">
                <div class="page-header">
                    <h1><i class="bi bi-clock-history"></i> Lịch sử Giao dịch</h1>
                    <p class="lead text-muted">Tất cả các giao dịch đến và đi từ ví của bạn.</p>
                </div>
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <div class="wallet-card h-100" id="history-wallet-container">
                        </div>
                    </div>
                    <div class="col-lg-4 d-flex align-items-center justify-content-center">
                         <button class="btn btn-primary w-100" data-action="refresh-history" disabled>
                            <i class="bi bi-arrow-clockwise me-2"></i>Làm mới Lịch sử
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div id="history-list-container">
                            <p class="text-center text-muted p-5">
                                <i class="bi bi-unlock-fill fs-1"></i><br>
                                Vui lòng mở khóa ví để xem lịch sử giao dịch.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [END] Bổ sung nội dung Tab History -->

            <!-- Explorer Tab -->
            <div class="tab-pane fade" id="explorer-pane" role="tabpanel">
                <div class="page-header"><h1>Trình khám phá chuỗi</h1><p class="lead text-muted">Xem trực tiếp các khối và giao dịch trên mạng lưới Sokchain.</p></div>
                <div class="d-flex justify-content-end mb-3"><button class="btn btn-primary btn-sm" data-action="refresh-explorer"><i class="bi bi-arrow-clockwise me-2"></i>Làm mới</button></div>
                <div id="explorer-content"><p class="text-center text-muted">Đang tải dữ liệu từ blockchain...</p></div>
            </div>

            <!-- Mining Tab -->
            <div class="tab-pane fade" id="mining-pane" role="tabpanel">
                <div class="page-header">
                    <h1><i class="bi bi-motherboard-fill"></i> Bảng điều khiển Khai thác</h1>
                    <p class="lead text-muted">Quản lý và mời gọi cộng đồng cùng tham gia đóng góp sức mạnh cho mạng lưới.</p>
                </div>

                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="mining-card h-100 p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="bi bi-server text-primary"></i> Trạng thái Thợ mỏ Server</h5>
                            </div>
                            <div class="text-center">
                                <div id="miner-status-icon" class="mb-3">
                                    <i class="bi bi-question-circle-fill text-secondary" style="font-size: 5rem;"></i>
                                </div>
                                <p id="miner-status-text" class="mb-4 fs-5">Đang kiểm tra trạng thái...</p>
                                <div class="px-md-4">
                                    <button id="miner-control-btn" class="btn btn-lg w-100" data-action="toggle-miner" disabled>
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        Vui lòng chờ
                                    </button>
                                </div>
                            </div>
                            <div class="alert alert-light border small mt-4 mb-0" style="background-color: rgba(230, 230, 230, 0.5) !important;">
                                <i class="bi bi-info-circle-fill me-1"></i>
                                Đây là tiến trình khai thác chạy trên chính máy chủ này. Tính năng này chỉ dành cho quản trị viên.
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="mining-card h-100 p-4">
                            <h5><i class="bi bi-people-fill text-success"></i> Tham gia với Máy tính của bạn</h5>
                            <p class="text-muted">
                                Bất kỳ ai cũng có thể đóng góp sức mạnh xử lý (CPU) cho mạng lưới và nhận phần thưởng SOK.
                            </p>
                            <ol class="list-group list-group-numbered">
                                <li class="list-group-item">
                                    <strong>Tải Client Miner:</strong> Tải về gói phần mềm dành cho thợ mỏ.
                                    <a href="https://www.mediafire.com/folder/4lkucjeou63zz/SOK_chain" target="_blank" class="btn btn-primary btn-sm w-100 mt-2">
                                        <i class="bi bi-download me-2"></i> Tải về từ MediaFire
                                    </a>
                                </li>
                                <li class="list-group-item">
                                    <strong>Thiết lập Ví:</strong> - Khi khởi động ứng dụng lần đầu, bạn sẽ được hướng dẫn tạo một ví mới hoặc mở ví đã có.
   - Ví của bạn sẽ được lưu (mã hóa hoặc không) vào một tệp (ví dụ: `my_smart_wallet.enc`).
   - CỰC KỲ QUAN TRỌNG: Hãy sao lưu tệp ví và ghi nhớ mật khẩu (nếu có) thật cẩn thận.<code>my_smart_wallet.enc</code>.
                                </li>
                                <li class="list-group-item">
                                    <strong>Chạy tiến trình:</strong> Mở File, chạy lệnh sau và nhập IP hoặc Domain của server SOK khi được hỏi:
                                    <code class="d-block bg-dark text-white p-2 rounded mt-2">sok_super_AIO</code>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Modals and Toasts -->
    <div class="modal fade" id="backupModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">🚨 CẢNH BÁO AN NINH</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p><strong>Hãy sao chép và cất giữ KHÓA BÍ MẬT ở nơi an toàn. Nếu làm mất, bạn sẽ mất quyền truy cập vào ví vĩnh viễn.</strong></p><textarea id="modal-private-key" class="form-control" readonly style="height: 180px;"></textarea></div><div class="modal-footer"><span id="modal-copied-message" class="text-success me-auto" style="display:none;">Đã sao chép!</span><button type="button" class="btn btn-success" data-action="copy-and-close-modal">Sao chép & Đóng</button></div></div></div></div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3"><div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><strong class="me-auto" id="toast-title">Thông báo</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div class="toast-body" id="toast-body"></div></div></div>
    <div class="modal fade" id="p2pDepositModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title"><i class="bi bi-box-arrow-in-right me-2"></i>Kích hoạt Lệnh bán P2P</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="fw-bold">Lệnh bán của bạn đã được tạo thành công!</p><p><strong>Bước tiếp theo:</strong> Để lệnh của bạn xuất hiện trên chợ, bạn cần gửi (ký quỹ) chính xác số SOK đã rao bán vào địa chỉ ví trung gian của hệ thống.</p><hr><div class="mb-3"><label class="form-label small">Số SOK cần gửi:</label><div id="p2p-modal-amount" class="wallet-info fw-bold text-danger">...</div></div><div class="mb-3"><label class="form-label small">Gửi đến địa chỉ Ví Ký quỹ:</label><div class="input-group"><input type="text" id="p2p-modal-address" class="form-control" readonly><button class="btn btn-outline-secondary" data-action="copy-p2p-address" title="Sao chép địa chỉ"><i class="bi bi-clipboard-plus"></i></button></div></div><div class="alert alert-warning small"><i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Lưu ý:</strong> Hãy đảm bảo bạn gửi chính xác số SOK trên. Hệ thống sẽ tự động phát hiện giao dịch và kích hoạt lệnh của bạn sau vài phút.</div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tôi đã hiểu</button></div></div></div></div>

    <!-- AI Chat Elements -->
    <div id="ai-chat-bubble"><i class="bi bi-robot"></i></div>
    <div id="ai-chat-window"><div class="chat-header"><strong>Trợ lý AI Sokchain</strong><button type="button" class="btn-close btn-close-white" id="ai-chat-close-btn"></button></div><div class="chat-body" id="ai-chat-body"><div class="chat-message ai-message">Xin chào! Tôi có thể giúp gì cho bạn về hệ sinh thái Sokchain?</div></div><div class="chat-footer"><form id="ai-chat-form"><div class="input-group"><input type="text" id="ai-chat-input" class="form-control" placeholder="Đặt câu hỏi..." autocomplete="off"><button class="btn btn-primary" type="submit"><i class="bi bi-send-fill"></i></button></div></form></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/elliptic@6.5.4/dist/elliptic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>
    <script src="/static/transaction.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & CONFIG ---
        let state = { userWallet: null, unlockedPrivateKey: null, treasuryInfo: null, initialBalance: 0 };
        const backupModalEl = document.getElementById('backupModal');
        const backupModal = new bootstrap.Modal(backupModalEl);
        const p2pDepositModal = new bootstrap.Modal(document.getElementById('p2pDepositModal'));
        const appToast = new bootstrap.Toast(document.getElementById('appToast'));

        // --- API HELPER ---
        const api = {
            async request(endpoint, method = 'GET', body = null) {
                try {
                    const options = { method, headers: { 'Content-Type': 'application/json' } };
                    if (body) options.body = JSON.stringify(body);
                    const response = await fetch(endpoint, options);
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `Lỗi không xác định từ server (${response.status})`);
                    }
                    return data;
                } catch (error) {
                    showToast(`Lỗi: ${error.message}`, 'Lỗi API');
                    throw error;
                }
            }
        };

        // --- UTILITY & RENDERING FUNCTIONS ---
        function showToast(message, title = 'Thông báo') {
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-body').innerText = message;
            appToast.show();
        }

        async function copyToClipboard(text) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                    showToast("Đã sao chép vào clipboard!", "Thành công");
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast("Đã sao chép vào clipboard!", "Thành công");
                }
            } catch (err) {
                console.error("Lỗi khi sao chép:", err);
                showToast("Không thể sao chép tự động.", "Lỗi");
            }
        }

        function createWorkerItem(worker) {
            const isOnline = (Date.now() / 1000 - worker.last_seen) < 180;
            const statusClass = isOnline ? 'status-online' : 'status-offline';
            const statusText = isOnline ? 'Trực tuyến' : 'Offline';
            return `<li class="worker-item"><div class="worker-info d-flex flex-column"><span class="worker-address" title="${worker.address}">${worker.address}</span><small><span class="status-indicator ${statusClass}"></span>${statusText}</small></div><button class="btn btn-sm" data-action="copy-address" data-address="${worker.address}"><i class="bi bi-clipboard-plus"></i></button></li>`;
        }
        
        // [START] Bổ sung hàm renderHistory
        async function renderHistory() {
            const container = document.getElementById('history-list-container');
            const refreshBtn = document.querySelector('button[data-action="refresh-history"]');

            if (!state.userWallet) {
                refreshBtn.disabled = true;
                container.innerHTML = `<p class="text-center text-muted p-5"><i class="bi bi-unlock-fill fs-1"></i><br>Vui lòng mở khóa ví để xem lịch sử giao dịch.</p>`;
                return;
            }

            refreshBtn.disabled = false;
            container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Đang tải lịch sử...</p></div>`;

            try {
                const history = await api.request(`/api/v1/transaction_history/${state.userWallet.address}`);
                if (!history.length) {
                    container.innerHTML = `<p class="text-center text-muted p-5"><i class="bi bi-emoji-frown fs-1"></i><br>Chưa có giao dịch nào được ghi nhận.</p>`;
                    return;
                }

                history.sort((a, b) => b.timestamp - a.timestamp);

                let html = '<div class="list-group">';
                history.forEach(tx => {
                    const txTime = new Date(tx.timestamp * 1000).toLocaleString('vi-VN');
                    let iconHtml = '';
                    let titleHtml = '';
                    let detailsHtml = '';
                    const amountStr = `${parseFloat(tx.amount).toFixed(8)} SOK`;

                    if (tx.from === "0") {
                        iconHtml = `<i class="bi bi-star-fill text-warning fs-4"></i>`;
                        titleHtml = `<strong>+ ${amountStr}</strong> - Phần thưởng Mạng lưới`;
                        detailsHtml = `Vào ví của bạn lúc ${txTime}`;
                    } else if (tx.type === 'sent' && state.treasuryInfo && tx.to === state.treasuryInfo.treasury_address) {
                        iconHtml = `<i class="bi bi-box-arrow-in-up text-info fs-4"></i>`;
                        titleHtml = `<strong>- ${amountStr}</strong> - Nạp tiền cho Website`;
                        detailsHtml = `Từ ví của bạn lúc ${txTime}`;
                    } else if (tx.type === 'sent') {
                        iconHtml = `<i class="bi bi-arrow-down-circle-fill text-danger fs-4"></i>`;
                        titleHtml = `<strong>- ${amountStr}</strong> - Gửi đi`;
                        detailsHtml = `Đến ví: <code class="small">${tx.to.substring(0, 20)}...</code> lúc ${txTime}`;
                    } else {
                        iconHtml = `<i class="bi bi-arrow-up-circle-fill text-success fs-4"></i>`;
                        titleHtml = `<strong>+ ${amountStr}</strong> - Nhận vào`;
                        detailsHtml = `Từ ví: <code class="small">${tx.from.substring(0, 20)}...</code> lúc ${txTime}`;
                    }

                    html += `
                        <div class="list-group-item list-group-item-action d-flex gap-3 py-3">
                            <div class="flex-shrink-0">${iconHtml}</div>
                            <div class="d-flex gap-2 w-100 justify-content-between">
                                <div>
                                    <h6 class="mb-0">${titleHtml}</h6>
                                    <p class="mb-0 opacity-75 small">${detailsHtml}</p>
                                </div>
                                <small class="opacity-50 text-nowrap"><i class="bi bi-hash"></i>${tx.tx_hash.substring(0, 8)}</small>
                            </div>
                        </div>`;
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = `<p class="text-center text-danger p-5"><i class="bi bi-exclamation-triangle-fill fs-1"></i><br>Lỗi khi tải lịch sử giao dịch.</p>`;
            }
        }
        // [END] Bổ sung hàm renderHistory
        
        function renderAll() {
            renderWallet();
            renderDashboard();
            renderManage();
            renderP2P();
            renderHistory(); // <-- [Bổ sung] Gọi hàm renderHistory
            renderExplorer();
            renderMining();
        }

        function renderWallet() {
            const walletContainers = document.querySelectorAll('.wallet-card[id$="-wallet-container"]');
            let htmlContent = '';
            if (state.userWallet) {
                htmlContent = `
                    <h5 class="text-success"><i class="bi bi-wallet-fill"></i> Ví đã Mở khóa</h5>
                    <div class="mb-2"><small>Địa chỉ:</small><p class="wallet-info">${state.userWallet.address}</p></div>
                    <div class="mb-3 balance-container"><small>Số dư:</small><p class="wallet-info">truy vấn SOK bot</p></div>
                    <button class="btn btn-sm btn-outline-danger w-100" data-action="logout"><i class="bi bi-lock-fill"></i> Khóa Ví</button>`;
                updateAllBalances();
            } else {
                htmlContent = `
                    <h5><i class="bi bi-unlock-fill"></i> Mở khóa Ví</h5><p class="small text-muted">Dùng ví để tương tác.</p>
                    <button class="btn btn-sm btn-success w-100 mb-2" data-action="create-wallet"><i class="bi bi-plus-lg"></i> Tạo Ví Mới</button>
                    <div class="mb-2"><label class="form-label small">Hoặc dán Private Key:</label><textarea class="form-control form-control-sm import-pk-pem" rows="4"></textarea></div>
                    <button class="btn btn-sm btn-primary w-100" data-action="import-wallet"><i class="bi bi-key-fill"></i> Mở khóa</button>`;
            }
            walletContainers.forEach(container => container.innerHTML = htmlContent);
        }

        async function renderDashboard() {
            try {
                const stats = await api.request('/api/v1/dashboard_stats');
                document.getElementById('active-workers').innerText = stats.active_workers;
                document.getElementById('total-websites').innerText = stats.total_websites;
                document.getElementById('views-completed').innerText = stats.views_completed_session;
                document.getElementById('blockchain-height').innerText = stats.blockchain_height > 0 ? stats.blockchain_height : 'N/A';
                document.getElementById('p2p-orders').innerText = stats.open_p2p_orders;
                
                const workers = await api.request('/api/v1/workers/list_by_type');
                const blList = document.getElementById('backlink-worker-list');
                const vwList = document.getElementById('view-worker-list');
                blList.innerHTML = workers.backlink_service.length > 0 ? workers.backlink_service.map(createWorkerItem).join('') : '<li class="text-muted text-center list-group-item">Không có worker nào.</li>';
                vwList.innerHTML = workers.view_worker.length > 0 ? workers.view_worker.map(createWorkerItem).join('') : '<li class="text-muted text-center list-group-item">Không có worker nào.</li>';
            } catch (e) { /* Ignore render errors */ }
        }

        async function renderManage() {
            const urlInput = document.getElementById('new-website-url');
            const addBtn = document.getElementById('add-btn');
            const fundingContainer = document.getElementById('funding-container');
            const websiteList = document.getElementById('website-list');
            if (state.userWallet) {
                urlInput.disabled = false;
                addBtn.disabled = false;
                if (state.treasuryInfo) {
                    fundingContainer.innerHTML = `
                        <h5><i class="bi bi-box-seam-fill"></i> Nạp SOK</h5>
                        <div class="mb-2"><label class="form-label small">Địa chỉ Kho bạc:</label><div class="wallet-info">${state.treasuryInfo.treasury_address.substring(0,25)}...</div></div>
                        <div class="mb-2"><label class="form-label small">Số SOK nạp:</label><input type="number" id="funding-amount" class="form-control form-control-sm" placeholder="Tối thiểu ${state.treasuryInfo.minimum_funding}"></div>
                        <button class="btn btn-sm btn-warning w-100" data-action="fund"><i class="bi bi-send-check-fill"></i> Nạp tiền</button>`;
                    fundingContainer.style.display = 'block';
                }
                const sites = await api.request(`/api/v1/websites/list?owner=${state.userWallet.address}`);
                websiteList.innerHTML = sites.length ? '' : '<li class="text-center text-muted">Bạn chưa thêm website nào.</li>';
                sites.forEach(site => {
                    const status = site.info.views_funded > 0 ? `<span class="text-success"><i class="bi bi-check-circle-fill"></i> Còn ${site.info.views_funded} lượt</span>` : '<span class="text-warning"><i class="bi bi-hourglass-split"></i> Chờ nạp</span>';
                    websiteList.innerHTML += `<li><span class="fw-bold">${site.url}</span><span>${status} | Xong: ${site.info.views_completed}</span><button class="btn btn-sm btn-danger" data-action="remove-website" data-url="${site.url}"><i class="bi bi-trash-fill"></i></button></li>`;
                });
            } else {
                urlInput.disabled = true;
                addBtn.disabled = true;
                fundingContainer.style.display = 'none';
                websiteList.innerHTML = '<li class="text-center text-muted">Mở khóa Ví để quản lý.</li>';
            }
        }
        
        async function renderP2P() {
            document.querySelector('button[data-action="create-sell-order"]').disabled = !state.userWallet;
            const tableBody = document.getElementById('open-orders-table');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Đang tải...</td></tr>';
            try {
                const orders = await api.request('/api/v1/p2p/orders/list');
                tableBody.innerHTML = '';
                if (!orders.length) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Chưa có lệnh bán nào.</td></tr>';
                }
                orders.forEach(order => {
                    tableBody.innerHTML += `<tr><td>${order.seller_address.substring(0,12)}...</td><td>${order.sok_amount}</td><td>${order.fiat_details}</td><td><button class="btn btn-sm btn-success" data-action="accept-p2p-order" data-order-id="${order.id}" ${state.userWallet ? '' : 'disabled'}>Mua</button></td></tr>`;
                });
            } catch (e) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Lỗi tải dữ liệu.</td></tr>';
            }
        }
        
        async function updateAllBalances() {
            if (!state.userWallet) return;
            const balanceContainers = document.querySelectorAll('.balance-container p');
            try {
                const data = await api.request(`/api/get_balance/${state.userWallet.address}`);
                const balanceValue = parseFloat(data.balance);
                balanceContainers.forEach(p => {
                    p.className = 'wallet-info';
                    p.textContent = `${balanceValue.toFixed(8)} SOK`;
                    p.classList.add(balanceValue > 0 ? 'text-success' : 'text-muted', 'fw-bold');
                });
            } catch (e) {
                balanceContainers.forEach(p => { p.textContent = 'Lỗi tải số dư'; p.classList.add('text-danger'); });
            }
        }

        async function renderExplorer() {
            const container = document.getElementById('explorer-content');
            container.innerHTML = `<p class="text-center text-muted">Đang tải dữ liệu từ blockchain...</p>`;
            try {
                const data = await api.request('/api/v1/explorer_data');
                if (!data.chain || data.chain.length === 0) {
                    container.innerHTML = `<p class="text-center text-warning">Không có khối nào để hiển thị.</p>`;
                    return;
                }
                let html = '';
                [...data.chain].reverse().forEach(block => {
                    const blockTime = new Date(block.timestamp * 1000).toLocaleString('vi-VN');
                    let txHtml = block.transactions?.length > 0 ?
                        block.transactions.map(tx => `<div class="tx-item">${tx.sender_address === "0" ? `<span class="badge bg-success">Thưởng</span>` : `<span class="badge bg-primary">Chuyển</span>`} <strong>${parseFloat(tx.amount).toFixed(4)} SOK</strong><div class="text-muted small">Đến: ${tx.recipient_address.substring(0, 20)}...</div></div>`).join('') :
                        '<div class="text-muted small p-2">Không có giao dịch.</div>';
                    html += `<div class="block-card"><div class="block-header">Khối #${block.index} <small class="float-end text-muted">${blockTime}</small></div><div class="block-details"><div class="text-truncate"><strong>Hash:</strong> <span class="text-info">${block.hash}</span></div><div>${txHtml}</div></div></div>`;
                });
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<p class="text-center text-danger">Không thể tải dữ liệu: ${e.message}</p>`;
            }
        }

        async function renderMining() {
            const statusIcon = document.getElementById('miner-status-icon');
            const statusText = document.getElementById('miner-status-text');
            const controlBtn = document.getElementById('miner-control-btn');
            try {
                const data = await api.request('/api/v1/miner/status');
                controlBtn.disabled = false;
                controlBtn.innerHTML = '';
                if (data.status === 'running') {
                    statusIcon.innerHTML = '<i class="bi bi-cpu-fill text-success" style="font-size: 4rem; animation: pulse 2s infinite;"></i>';
                    statusText.innerHTML = `Đang hoạt động. ${data.pid ? `(PID: ${data.pid})` : ''}`;
                    controlBtn.innerHTML = '<i class="bi bi-stop-circle-fill me-2"></i>Dừng Khai thác';
                    controlBtn.className = 'btn btn-lg w-100 btn-danger';
                    controlBtn.dataset.nextState = 'stop';
                } else {
                    statusIcon.innerHTML = '<i class="bi bi-power text-danger" style="font-size: 4rem;"></i>';
                    statusText.textContent = 'Đã dừng.';
                    controlBtn.innerHTML = '<i class="bi bi-play-circle-fill me-2"></i>Bắt đầu Khai thác';
                    controlBtn.className = 'btn btn-lg w-100 btn-success';
                    controlBtn.dataset.nextState = 'start';
                }
            } catch (error) {
                statusIcon.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 4rem;"></i>';
                statusText.textContent = 'Lỗi khi kiểm tra trạng thái.';
                controlBtn.disabled = true;
                controlBtn.textContent = 'Thử lại sau';
            }
        }

        function pollForBalanceUpdate(maxAttempts = 10, interval = 3000) {
            let attempts = 0;
            const poller = setInterval(async () => {
                attempts++;
                if (attempts > maxAttempts) {
                    clearInterval(poller);
                    showToast("Giao dịch đã gửi nhưng số dư chưa cập nhật.", "Cảnh báo");
                    return;
                }
                try {
                    const data = await api.request(`/api/get_balance/${state.userWallet.address}`);
                    const newBalance = parseFloat(data.balance);
                    if (newBalance !== state.initialBalance) {
                        clearInterval(poller);
                        showToast("Số dư đã được cập nhật!", "Thành công");
                        renderAll();
                    }
                } catch (e) { /* Ignore poll errors */ }
            }, interval);
        }

        async function handleTransaction() {
            try {
                const data = await api.request(`/api/get_balance/${state.userWallet.address}`);
                state.initialBalance = parseFloat(data.balance);
            } catch (e) {
                state.initialBalance = 0;
            }
            showToast("Giao dịch đã được gửi! Đang chờ xác nhận...", "Thông tin");
            pollForBalanceUpdate();
        }

        function triggerSokWiggle() {
            const sokText = document.getElementById('sok-brand-text');
            if (sokText) {
                sokText.classList.add('animate-wiggle');
                setTimeout(() => sokText.classList.remove('animate-wiggle'), 500);
            }
        }

        // --- EVENT HANDLING ---
        document.body.addEventListener('click', async (event) => {
            const button = event.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const handleSuccessLogin = (walletData, pkPem) => {
                state.userWallet = { address: walletData.address, public_key_pem: walletData.public_key_pem };
                state.unlockedPrivateKey = pkPem;
                renderAll();
                showToast("Ví đã được mở khóa thành công!", "Thành công");
                aiAgent.triggerWelcome();
            };

            switch (action) {
                case 'create-wallet': {
                    const data = await api.request('/api/create_wallet', 'POST');
                    if(data){
                        backupModalEl.dataset.walletInfo = JSON.stringify(data);
                        document.getElementById('modal-private-key').value = data.private_key_pem;
                        backupModal.show();
                    }
                    break;
                }
                case 'copy-and-close-modal': {
                    const pkTextarea = document.getElementById('modal-private-key');
                    await copyToClipboard(pkTextarea.value);
                    
                    document.getElementById('modal-copied-message').style.display = 'inline';
                    setTimeout(() => {
                        const walletData = JSON.parse(backupModalEl.dataset.walletInfo || '{}');
                        handleSuccessLogin(walletData, walletData.private_key_pem);
                        backupModal.hide();
                    }, 1500);
                    break;
                }
                case 'import-wallet': {
                    const pkPem = button.parentElement.querySelector('.import-pk-pem').value.trim();
                    if (!pkPem) return showToast("Vui lòng nhập Private Key.", "Cảnh báo");
                    const walletData = await api.request('/api/wallet_from_pk', 'POST', { private_key_pem: pkPem });
                    if (walletData) handleSuccessLogin(walletData, pkPem);
                    break;
                }
                case 'logout': {
                    aiAgent.addMessage("Bạn đã khóa ví. Tôi sẽ không thể truy cập thông tin tài khoản của bạn nữa.", 'ai');
                    state = { ...state, userWallet: null, unlockedPrivateKey: null };
                    renderAll();
                    break;
                }
                case 'copy-address': {
                    await copyToClipboard(button.dataset.address);
                    break;
                }
                case 'add-website': {
                    const newUrl = document.getElementById('new-website-url').value.trim();
                    if (!newUrl) return showToast('Vui lòng nhập URL.', 'Cảnh báo');
                    await api.request('/api/v1/websites/add', 'POST', { url: newUrl, owner_pk_pem: state.userWallet.public_key_pem });
                    showToast('Thêm website thành công!', 'Thành công');
                    document.getElementById('new-website-url').value = '';
                    renderManage();
                    break;
                }
                case 'remove-website': {
                    if (confirm(`Xóa website: ${button.dataset.url}?`)) {
                        await api.request('/api/v1/websites/remove', 'POST', { url: button.dataset.url, owner_address: state.userWallet.address });
                        showToast('Đã xóa website.', 'Thành công');
                        renderManage();
                    }
                    break;
                }
                case 'fund': {
                    const fundAmount = document.getElementById('funding-amount').value.trim();
                    if (!fundAmount || parseFloat(fundAmount) <= 0) return showToast("Nhập số tiền hợp lệ.", "Cảnh báo");
                    await api.request('/api/direct_fund', 'POST', { private_key_pem: state.unlockedPrivateKey, recipient_address: state.treasuryInfo.treasury_address, amount: fundAmount });
                    handleTransaction();
                    break;
                }
                case 'create-sell-order': {
                    const sokAmount = document.getElementById('sokAmount').value.trim();
                    const fiatDetails = document.getElementById('fiatDetails').value.trim();
                    if (!sokAmount || !fiatDetails || parseFloat(sokAmount) <= 0) return showToast("Vui lòng nhập đầy đủ thông tin và số SOK hợp lệ.", "Cảnh báo");
                    const data = await api.request('/api/v1/p2p/orders/create', 'POST', { seller_address: state.userWallet.address, sok_amount: sokAmount, fiat_details: fiatDetails });
                    if (data) {
                        document.getElementById('p2p-modal-amount').textContent = `${sokAmount} SOK`;
                        document.getElementById('p2p-modal-address').value = data.escrow_address;
                        p2pDepositModal.show();
                        document.getElementById('sokAmount').value = '';
                        document.getElementById('fiatDetails').value = '';
                    }
                    break;
                }
                case 'copy-p2p-address': {
                    const addressInput = document.getElementById('p2p-modal-address');
                    await copyToClipboard(addressInput.value);
                    const icon = button.querySelector('i');
                    icon.className = 'bi bi-clipboard-check-fill';
                    setTimeout(() => icon.className = 'bi bi-clipboard-plus', 2000);
                    break;
                }
                case 'accept-p2p-order': {
                    if (!state.userWallet) return showToast("Vui lòng mở khóa ví để mua.", "Yêu cầu");
                    if (!confirm("Bạn có chắc chắn muốn mua SOK từ lệnh này không?")) return;
                    const result = await api.request(`/api/v1/p2p/orders/${button.dataset.orderId}/accept`, 'POST', { buyer_address: state.userWallet.address });
                    if (result) {
                        alert(`${result.message}\n\nVui lòng chuyển khoản đến người bán và chờ họ xác nhận để nhận SOK.`);
                        renderP2P();
                    }
                    break;
                }
                case 'refresh-p2p-orders':
                    renderP2P();
                    break;
                
                case 'refresh-explorer': {
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Đang tải...';
                    showToast("Đang làm mới dữ liệu chuỗi...");
                    try {
                        await renderExplorer();
                    } finally {
                        setTimeout(() => {
                            button.disabled = false;
                            button.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Làm mới';
                        }, 5000); // Cooldown 5 giây
                    }
                    break;
                }
                
                // [START] Bổ sung sự kiện cho nút làm mới History
                case 'refresh-history': {
                    button.disabled = true;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Đang tải...';
                    await renderHistory();
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Làm mới Lịch sử';
                    }, 1000);
                    break;
                }
                // [END] Bổ sung sự kiện cho nút làm mới History
                
                case 'toggle-miner': {
                    const nextState = button.dataset.nextState;
                    button.disabled = true;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...';
                    try {
                        const result = await api.request(`/api/v1/miner/${nextState}`, 'POST');
                        showToast(result.message, 'Thành công');
                    } catch (error) { /* Handled by API helper */ }
                    finally {
                        setTimeout(renderMining, 1000);
                    }
                    break;
                }
            }
        });

        // [START] Bổ sung sự kiện khi chuyển tab History
        const historyTab = document.querySelector('button[data-bs-target="#history-pane"]');
        if (historyTab) {
            historyTab.addEventListener('shown.bs.tab', event => {
                renderHistory();
            });
        }
        // [END] Bổ sung sự kiện khi chuyển tab History

        // --- AI CHAT AGENT ---
        const aiAgent = {
            bubble: document.getElementById('ai-chat-bubble'),
            window: document.getElementById('ai-chat-window'),
            body: document.getElementById('ai-chat-body'),
            form: document.getElementById('ai-chat-form'),
            input: document.getElementById('ai-chat-input'),
            init() {
                this.bubble.addEventListener('click', () => this.toggle());
                document.getElementById('ai-chat-close-btn').addEventListener('click', () => this.hide());
                this.form.addEventListener('submit', (e) => this.handleUserInput(e));
            },
            toggle() {
                this.window.classList.toggle('show');
                if (this.window.classList.contains('show')) this.input.focus();
            },
            hide() { this.window.classList.remove('show'); },
            addMessage(message, sender) {
                const div = document.createElement('div');
                div.className = `chat-message ${sender}-message`;
                div.textContent = message;
                this.body.appendChild(div);
                this.body.scrollTop = this.body.scrollHeight;
                if (sender === 'ai') triggerSokWiggle();
            },
            showTyping() {
                const i = document.createElement('div');
                i.id = 'ai-typing-indicator';
                i.className = 'chat-message ai-message';
                i.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                this.body.appendChild(i);
                this.body.scrollTop = this.body.scrollHeight;
                triggerSokWiggle();
            },
            hideTyping() { document.getElementById('ai-typing-indicator')?.remove(); },
            async handleUserInput(e) {
                e.preventDefault();
                const userInput = this.input.value.trim();
                if (!userInput) return;
                this.addMessage(userInput, 'user');
                this.input.value = '';
                this.showTyping();
                try {
                    const response = await api.request('/api/v1/ai/chat', 'POST', { query: userInput, address: state.userWallet ? state.userWallet.address : null });
                    this.hideTyping();
                    this.addMessage(response.reply, 'ai');
                } catch (error) {
                    this.hideTyping();
                    this.addMessage("Xin lỗi, tôi gặp sự cố khi kết nối. Vui lòng thử lại sau.", 'ai');
                }
            },
            triggerWelcome() {
                if (!this.window.classList.contains('show')) this.toggle();
                this.showTyping();
                setTimeout(async () => {
                    try {
                        const response = await api.request('/api/v1/ai/chat', 'POST', { query: "Chào bạn, hãy tóm tắt tài khoản của tôi.", address: state.userWallet.address });
                        this.hideTyping();
                        this.addMessage(response.reply, 'ai');
                    } catch (error) {
                        this.hideTyping();
                        this.addMessage("Chào mừng bạn quay trở lại!", 'ai');
                    }
                }, 500);
            }
        };

        // --- INITIALIZATION ---
        async function initialize() {
            renderAll();
            aiAgent.init();
            
            function randomWiggleLoop() {
                const randomDelay = Math.random() * 13000 + 7000;
                setTimeout(() => {
                    triggerSokWiggle();
                    randomWiggleLoop();
                }, randomDelay);
            }
            randomWiggleLoop();

            setInterval(renderDashboard, 20000);
            setInterval(renderMining, 30000);

            try {
                state.treasuryInfo = await api.request('/api/v1/payment_info');
            } catch (e) {
                showToast("Lỗi nghiêm trọng khi tải cấu hình ban đầu.", "Lỗi hệ thống");
            }
        }
        
        initialize();
    });
    </script>
</body>
</html>